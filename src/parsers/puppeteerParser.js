import puppeteer from 'puppeteer-extra';
import StealthPlugin from 'puppeteer-extra-plugin-stealth';
import fs from 'fs';

puppeteer.use(StealthPlugin());

const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

// === –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ===
const [, , productUrl, targetRegionRaw] = process.argv;

if (!productUrl || !targetRegionRaw) {
  console.error('Usage: node puppeteer.js <PRODUCT_URL> <REGION>');
  process.exit(1);
}

const targetRegion = targetRegionRaw.trim();

// === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Cloudflare / anti-bot ===
async function waitForCloudflare(page, timeoutSec = 20) {
  const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
  let html = await page.content().catch(() => '');

  if (!checkPattern.test(html)) return true;

  console.warn('‚ö†Ô∏è  Detected anti-bot check page. Waiting...');

  const start = Date.now();
  while ((Date.now() - start) < timeoutSec * 1000) {
    await sleep(1000);
    html = await page.content().catch(() => '');
    if (!checkPattern.test(html)) {
      console.log('‚úÖ Anti-bot check passed\n');
      return true;
    }
  }

  console.error(`‚ùå Anti-bot check timeout after ${timeoutSec}s`);
  fs.writeFileSync('cloudflare-page.html', html);
  return false;
}

// === –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—É—Å—Ç–æ–π—á–∏–≤–∞—è –≤–µ—Ä—Å–∏—è —Å fallback) ===
async function selectRegion(page, targetRegion) {
  console.log(`üîÑ Attempting to select region: "${targetRegion}"`);

  const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
  const normalizedTarget = normalize(targetRegion);

  try {
    await page.waitForSelector('button[class*="Region_region"], button[data-testid*="region"]', { timeout: 10000 });
    const currentRegion = await page.$eval(
      'button[class*="Region_region"], button[data-testid*="region"]',
      el => el.textContent.trim()
    ).catch(() => null);

    console.log(`üìç Current region: "${currentRegion || 'unknown'}"`);

    if (currentRegion && normalize(currentRegion) === normalizedTarget) {
      console.log(`‚úÖ Region already correct!\n`);
      return true;
    }

    console.log('üñ±Ô∏è Clicking region button...');
    await page.click('button[class*="Region_region"], button[data-testid*="region"]');

    const modalSelectors = [
      'div[role="dialog"]',
      'div[class*="UiRegionListBase_listWrapper"]',
      'div[class*="RegionModal"]',
      'div[class*="RegionSelect"]'
    ];

    let modalAppeared = false;
    for (const selector of modalSelectors) {
      try {
        await page.waitForSelector(selector, { visible: true, timeout: 5000 });
        modalAppeared = true;
        console.log(`‚úÖ Modal appeared via selector: ${selector}`);
        break;
      } catch {}
    }

    if (!modalAppeared) {
      console.warn('‚ö†Ô∏è Region modal did not appear. Skipping selection and continuing...');
      return false; // fallback
    }

    const clicked = await page.evaluate((target) => {
      const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
      const normalizedTarget = normalize(target);

      const allButtons = Array.from(document.querySelectorAll('button, li button, [role="option"]'));
      for (const button of allButtons) {
        const text = button.textContent.trim();
        const normalizedText = normalize(text);
        if (normalizedText === normalizedTarget || normalizedText.includes(normalizedTarget)) {
          button.click();
          return text;
        }
      }
      return null;
    }, targetRegion);

    if (!clicked) {
      console.warn(`‚ö†Ô∏è Region "${targetRegion}" not found in modal. Continuing without changing region...`);
      return false; // fallback
    }

    console.log(`‚úÖ Clicked region: "${clicked}"`);
    await sleep(4000);

    const newRegion = await page.$eval(
      'button[class*="Region_region"], button[data-testid*="region"]',
      el => el.textContent.trim()
    ).catch(() => null);

    if (newRegion && normalize(newRegion) === normalizedTarget) {
      console.log(`‚úÖ Region verified: "${newRegion}"\n`);
      return true;
    } else {
      console.warn(`‚ö†Ô∏è Region verification failed, still "${newRegion}". Continuing parsing...`);
      return false; // fallback
    }

  } catch (error) {
    console.warn(`‚ö†Ô∏è Region selection failed: ${error.message}. Continuing parsing...`);
    return false; // fallback
  }
}

// === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–µ ===
async function extractProductData(page) {
  console.log('üìä Extracting product data...\n');

  const productData = await page.evaluate(() => {
    const result = {
      price: null,
      priceOld: null,
      rating: null,
      reviewCount: null,
      debug: {}
    };

    const extractNumber = (text) => {
      if (!text) return null;
      const cleaned = text.replace(/\s+/g, '').replace(',', '.').replace('‚ÇΩ','');
      const match = cleaned.match(/[\d]+\.?[\d]*/);
      return match ? parseFloat(match[0]) : null;
    };

    const container = document.querySelector(
      '[class*="ProductPage"], [class*="ProductCard"], main, [class*="product-info"], article'
    ) || document;

    const priceSelectors = [
      '.Price_price__3rj7L',
      '[class*="Price_price"]:not([class*="old"])',
      '[data-testid="product-price"]',
      'span[class*="price"]:not([class*="old"])'
    ];

    // === –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ ===
    for (const selector of priceSelectors) {
      const el = container.querySelector(selector);
      if (el && el.textContent.includes('‚ÇΩ')) {
        const price = extractNumber(el.textContent);
        if (price && price > 0 && price < 1000000) {
          result.price = price;
          result.debug.priceSelector = selector;
          break;
        }
      }
    }

    // === –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ —Ä—è–¥–æ–º —Å –æ—Å–Ω–æ–≤–Ω–æ–π ===
    if (result.price) {
      let priceElement = null;
      for (const selector of priceSelectors) {
        priceElement = container.querySelector(selector);
        if (priceElement) break;
      }

      if (priceElement) {
        const parent = priceElement.parentNode;
        const siblings = Array.from(parent.querySelectorAll('span, div, s, del'));

        for (const el of siblings) {
          if (!el.textContent.includes('‚ÇΩ')) continue;
          const num = extractNumber(el.textContent);
          if (num && num > result.price) {
            result.priceOld = num;
            result.debug.priceOldSelector = el.tagName + ' (sibling of price)';
            break;
          }
        }
      }
    }

    // === –†–µ–π—Ç–∏–Ω–≥ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ —á–µ—Ä–µ–∑ schema.org ===
    const ratingMeta = document.querySelector('section[itemprop="aggregateRating"] meta[itemprop="ratingValue"]');
    const reviewCountMeta = document.querySelector('section[itemprop="aggregateRating"] meta[itemprop="reviewCount"]');

    if (ratingMeta) {
      const rating = parseFloat(ratingMeta.getAttribute('content'));
      if (!isNaN(rating)) result.rating = rating;
    }

    if (reviewCountMeta) {
      const count = parseInt(reviewCountMeta.getAttribute('content'), 10);
      if (!isNaN(count)) result.reviewCount = count;
    }

    return result;
  });

  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  console.log('üìä Extraction results:');
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  if (productData.price !== null) console.log(`‚úÖ Price: ${productData.price} ‚ÇΩ  Selector: ${productData.debug.priceSelector}`);
  else console.log(`‚ùå Price: NOT FOUND`);
  if (productData.priceOld !== null) console.log(`‚úÖ Old price: ${productData.priceOld} ‚ÇΩ  Selector: ${productData.debug.priceOldSelector}`);
  else console.log(`‚ö™ Old price: not found`);
  if (productData.rating !== null) console.log(`‚úÖ Rating: ${productData.rating} / 5.0`);
  else console.log(`‚ùå Rating: NOT FOUND`);
  if (productData.reviewCount !== null) console.log(`‚úÖ Review count: ${productData.reviewCount}`);
  else console.log(`‚ùå Review count: NOT FOUND`);
  console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');

  return productData;
}

// === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
(async () => {
  console.log('üöÄ Starting parser...');
  console.log(`üì¶ Product URL: ${productUrl}`);
  console.log(`üåç Target region: ${targetRegion}\n`);

  const browser = await puppeteer.launch({
    headless: false,
    args: ['--no-sandbox','--disable-setuid-sandbox','--start-maximized','--disable-blink-features=AutomationControlled'],
    defaultViewport: null
  });

  const page = await browser.newPage();
  await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36');
  page.setDefaultTimeout(30000);

  page.on('console', msg => {
    const text = msg.text();
    if (text.includes('Found') || text.includes('Looking')) console.log(`   [Browser] ${text}`);
  });

  try {
    console.log('üåê Loading product page...');
    await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
    console.log('‚úì Page loaded\n');

    const cfPassed = await waitForCloudflare(page, 25);
    if (!cfPassed) throw new Error('Anti-bot check failed');

    await sleep(2000);
    await selectRegion(page, targetRegion);
    await sleep(3000);

    try { await page.waitForSelector('.Price_price__3rj7L, [class*="Price_price"]', { timeout: 10000, visible: true }); } catch {}

    const productData = await extractProductData(page);

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ ===
    const outputLines = [];
    if (productData.price !== null) outputLines.push(`price=${productData.price}`);
    if (productData.priceOld !== null) outputLines.push(`priceOld=${productData.priceOld}`);
    if (productData.rating !== null) outputLines.push(`rating=${productData.rating}`);
    if (productData.reviewCount !== null) outputLines.push(`reviewCount=${productData.reviewCount}`);

    if (outputLines.length > 0) {
      const content = outputLines.join('\n');
      fs.writeFileSync('product.txt', content);
      console.log('üíæ Saved to product.txt\n');
      console.log('üìÑ File content:');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log(content);
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    } else {
      console.warn('‚ö†Ô∏è  No data extracted!');
      const html = await page.content();
      fs.writeFileSync('debug.html', html);
      console.log('üîç Saved debug.html for inspection\n');
    }

    console.log('üì∏ Taking screenshot...');
    await page.screenshot({ path: 'screenshot.jpg', fullPage: true, type: 'jpeg', quality: 90 });
    console.log('‚úÖ Screenshot saved: screenshot.jpg\n');

  } catch (err) {
    console.error('\n‚ùå Parser failed:', err.message);
    const html = await page.content().catch(() => null);
    if (html) fs.writeFileSync('error-page.html', html);
    throw err;
  } finally {
    await browser.close();
    console.log('üîí Browser closed\n');
  }
})()
.then(() => { console.log('‚úÖ Parser completed successfully!'); process.exit(0); })
.catch((err) => { console.error('üí• Critical error:', err.message); process.exit(1); });









// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

// // === –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ===
// const [, , productUrl, targetRegionRaw] = process.argv;

// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteer.js <PRODUCT_URL> <REGION>');
//   console.error('Example: node puppeteer.js "https://www.vprok.ru/product/..." "–ú–æ—Å–∫–≤–∞ –∏ –æ–±–ª–∞—Å—Ç—å"');
//   process.exit(1);
// }

// const targetRegion = targetRegionRaw.trim();

// // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Cloudflare / anti-bot ===
// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(() => '');
  
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è  Detected anti-bot check page. Waiting...');

//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(() => '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed\n');
//       return true;
//     }
//   }

//   console.error(`‚ùå Anti-bot check timeout after ${timeoutSec}s`);
//   fs.writeFileSync('cloudflare-page.html', html);
//   return false;
// }

// // === –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
// async function selectRegion(page, targetRegion) {
//   console.log(`üîÑ Attempting to select region: "${targetRegion}"`);
  
//   const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
//   const normalizedTarget = normalize(targetRegion);

//   try {
//     const currentRegion = await page.$eval(
//       'button[class^="Region_region__"] .Region_text__Wm7FO',
//       el => el.textContent.trim()
//     ).catch(() => null);

//     console.log(`üìç Current region: "${currentRegion || 'unknown'}"`);

//     if (currentRegion && normalize(currentRegion) === normalizedTarget) {
//       console.log(`‚úÖ Region already correct!\n`);
//       return true;
//     }

//     console.log('üñ±Ô∏è  Clicking region button...');
//     await page.click('button[class^="Region_region__"]');
//     await sleep(1500);

//     const modalVisible = await page.evaluate(() => {
//       const modal = document.querySelector('div[role="dialog"]');
//       return modal && modal.offsetParent !== null;
//     });

//     if (!modalVisible) {
//       console.error('‚ùå Modal did not appear');
//       return false;
//     }

//     console.log('‚úì Modal opened');

//     const clicked = await page.evaluate((target) => {
//       const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
//       const buttons = document.querySelectorAll('div[class^="UiRegionListBase_listWrapper__"] ul li button');
//       const normalizedTarget = normalize(target);
//       for (const button of buttons) {
//         const text = button.textContent.trim();
//         const normalizedText = normalize(text);
//         if (normalizedText === normalizedTarget || normalizedText.includes(normalizedTarget)) {
//           button.click();
//           return text;
//         }
//       }
//       return null;
//     }, targetRegion);

//     if (!clicked) {
//       console.error(`‚ùå Region "${targetRegion}" not found in list`);
//       return false;
//     }

//     console.log(`‚úÖ Clicked region: "${clicked}"`);
//     await sleep(3000);

//     const newRegion = await page.$eval(
//       'button[class^="Region_region__"] .Region_text__Wm7FO',
//       el => el.textContent.trim()
//     ).catch(() => null);

//     if (newRegion && normalize(newRegion) === normalizedTarget) {
//       console.log(`‚úÖ Region verified: "${newRegion}"\n`);
//       return true;
//     } else {
//       console.warn(`‚ö†Ô∏è  Region verification failed. Got: "${newRegion}"\n`);
//       return false;
//     }

//   } catch (error) {
//     console.error(`‚ùå Failed to select region: ${error.message}\n`);
//     return false;
//   }
// }

// // === –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –û –¢–û–í–ê–†–ï ===
// async function extractProductData(page) {
//   console.log('üìä Extracting product data...\n');

//   const productData = await page.evaluate(() => {
//     const result = {
//       price: null,
//       priceOld: null,
//       rating: null,
//       reviewCount: null,
//       debug: {}
//     };

//     const extractNumber = (text) => {
//       if (!text) return null;
//       const cleaned = text.replace(/\s+/g, '').replace(',', '.');
//       const match = cleaned.match(/[\d]+\.?[\d]*/);
//       return match ? parseFloat(match[0]) : null;
//     };

//     const productContainer = document.querySelector(
//       '[class*="ProductPage"], [class*="ProductCard"], main, [class*="product-info"], article'
//     ) || document;

//     const searchContext = productContainer;

//     const priceSelectors = [
//       '.Price_price__3rj7L',
//       '[class*="Price_price"]:not([class*="old"])',
//       '[data-testid="product-price"]',
//       'span[class*="price"]:not([class*="old"])'
//     ];

//     for (const selector of priceSelectors) {
//       const el = searchContext.querySelector(selector);
//       if (el && el.textContent.includes('‚ÇΩ')) {
//         const price = extractNumber(el.textContent);
//         if (price && price > 0 && price < 1000000) {
//           result.price = price;
//           result.debug.priceSelector = selector;
//           console.log('Found price:', price, 'via', selector);
//           break;
//         }
//       }
//     }

//     if (result.price) {
//       let priceElement = null;
//       for (const selector of priceSelectors) {
//         priceElement = searchContext.querySelector(selector);
//         if (priceElement) break;
//       }
//       if (priceElement) {
//         const priceContainer = priceElement.closest('[class*="Price"], [class*="price"]');
//         if (priceContainer) {
//           const oldPriceSelectors = [
//             '.Price_oldPrice__1mNRO',
//             '[class*="Price_oldPrice"]',
//             '[class*="oldPrice"]',
//             's',
//             'del'
//           ];
//           for (const selector of oldPriceSelectors) {
//             const el = priceContainer.querySelector(selector);
//             if (el && el.textContent.includes('‚ÇΩ')) {
//               const oldPrice = extractNumber(el.textContent);
//               if (oldPrice && oldPrice > result.price) {
//                 result.priceOld = oldPrice;
//                 result.debug.priceOldSelector = selector + ' (in price container)';
//                 console.log('Found old price:', oldPrice, 'via', selector);
//                 break;
//               }
//             }
//           }
//           if (!result.priceOld) {
//             const allInContainer = priceContainer.querySelectorAll('span, div');
//             for (const el of allInContainer) {
//               const style = window.getComputedStyle(el);
//               if (style.textDecoration.includes('line-through') && el.textContent.includes('‚ÇΩ')) {
//                 const oldPrice = extractNumber(el.textContent);
//                 if (oldPrice && oldPrice > result.price) {
//                   result.priceOld = oldPrice;
//                   result.debug.priceOldSelector = 'line-through (in price container)';
//                   console.log('Found old price:', oldPrice, 'via line-through style');
//                   break;
//                 }
//               }
//             }
//           }
//         }
//       }
//     }

//     // === –†–µ–π—Ç–∏–Ω–≥ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ —á–µ—Ä–µ–∑ schema.org ===
//     const ratingMeta = document.querySelector('section[itemprop="aggregateRating"] meta[itemprop="ratingValue"]');
//     const reviewCountMeta = document.querySelector('section[itemprop="aggregateRating"] meta[itemprop="reviewCount"]');

//     if (ratingMeta) {
//       const rating = parseFloat(ratingMeta.getAttribute('content'));
//       if (!isNaN(rating)) {
//         result.rating = rating;
//         result.debug.ratingSelector = 'meta[itemprop="ratingValue"]';
//         console.log('Found rating via schema.org:', rating);
//       }
//     }

//     if (reviewCountMeta) {
//       const count = parseInt(reviewCountMeta.getAttribute('content'), 10);
//       if (!isNaN(count)) {
//         result.reviewCount = count;
//         result.debug.reviewSelector = 'meta[itemprop="reviewCount"]';
//         console.log('Found review count via schema.org:', count);
//       }
//     }

//     // === –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–∏—Å–∫ —Ä–µ–π—Ç–∏–Ω–≥–∞ ===
//     if (result.rating === null) {
//       const ratingSelectors = ['.Rating_rating__1KFrt', '[class*="Rating_rating"]', '[class*="rating"]'];
//       for (const selector of ratingSelectors) {
//         const el = searchContext.querySelector(selector);
//         if (el) {
//           const match = el.textContent.trim().match(/([0-5](?:[.,]\d)?)/);
//           if (match) {
//             const rating = parseFloat(match[1].replace(',', '.'));
//             if (!isNaN(rating) && rating >= 0 && rating <= 5) {
//               result.rating = rating;
//               result.debug.ratingSelector = selector + ' (fallback)';
//               console.log('Found rating (fallback):', rating);
//               break;
//             }
//           }
//         }
//       }
//     }

//     // === –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–∏—Å–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤ ===
//     if (result.reviewCount === null) {
//       const reviewLinks = searchContext.querySelectorAll('a[href*="review"], button');
//       for (const el of reviewLinks) {
//         const text = el.textContent.toLowerCase();
//         if (text.includes('–æ—Ç–∑—ã–≤') && text.match(/\d+/)) {
//           const numbers = text.match(/\d+/g);
//           if (numbers && numbers.length > 0) {
//             const count = parseInt(numbers[0]);
//             if (count > 0 && count < 100000) {
//               result.reviewCount = count;
//               result.debug.reviewSelector = 'link with "–æ—Ç–∑—ã–≤" (fallback)';
//               console.log('Found review count (fallback):', count);
//               break;
//             }
//           }
//         }
//       }
//     }

//     return result;
//   });

//   // === –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ===
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
//   console.log('üìä Extraction results:');
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
//   if (productData.price !== null) console.log(`‚úÖ Price: ${productData.price} ‚ÇΩ  Selector: ${productData.debug.priceSelector}`);
//   else console.log(`‚ùå Price: NOT FOUND`);
//   if (productData.priceOld !== null) console.log(`‚úÖ Old price: ${productData.priceOld} ‚ÇΩ  Selector: ${productData.debug.priceOldSelector}`);
//   else console.log(`‚ö™ Old price: not found`);
//   if (productData.rating !== null) console.log(`‚úÖ Rating: ${productData.rating} / 5.0  Selector: ${productData.debug.ratingSelector}`);
//   else console.log(`‚ùå Rating: NOT FOUND`);
//   if (productData.reviewCount !== null) console.log(`‚úÖ Review count: ${productData.reviewCount}  Selector: ${productData.debug.reviewSelector}`);
//   else console.log(`‚ùå Review count: NOT FOUND`);
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');

//   return productData;
// }

// // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
// (async () => {
//   console.log('üöÄ Starting parser...');
//   console.log(`üì¶ Product URL: ${productUrl}`);
//   console.log(`üåç Target region: ${targetRegion}\n`);

//   const browser = await puppeteer.launch({
//     headless: false,
//     args: ['--no-sandbox','--disable-setuid-sandbox','--start-maximized','--disable-blink-features=AutomationControlled'],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36');
//   page.setDefaultTimeout(30000);

//   page.on('console', msg => {
//     const text = msg.text();
//     if (text.includes('Found') || text.includes('Looking')) console.log(`   [Browser] ${text}`);
//   });

//   try {
//     console.log('üåê Loading product page...');
//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded\n');

//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) throw new Error('Anti-bot check failed');

//     await sleep(2000);

//     await selectRegion(page, targetRegion);
//     await sleep(3000);

//     try { await page.waitForSelector('.Price_price__3rj7L, [class*="Price_price"]', { timeout: 10000, visible: true }); } catch {}
    
//     const productData = await extractProductData(page);

//     // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ ===
//     const outputLines = [];
//     if (productData.price !== null) outputLines.push(`price=${productData.price}`);
//     if (productData.priceOld !== null) outputLines.push(`priceOld=${productData.priceOld}`);
//     if (productData.rating !== null) outputLines.push(`rating=${productData.rating}`);
//     if (productData.reviewCount !== null) outputLines.push(`reviewCount=${productData.reviewCount}`);

//     if (outputLines.length > 0) {
//       const content = outputLines.join('\n');
//       fs.writeFileSync('product.txt', content);
//       console.log('üíæ Saved to product.txt\n');
//       console.log('üìÑ File content:');
//       console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
//       console.log(content);
//       console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
//     } else {
//       console.warn('‚ö†Ô∏è  No data extracted!');
//       const html = await page.content();
//       fs.writeFileSync('debug.html', html);
//       console.log('üîç Saved debug.html for inspection\n');
//     }

//     // === –°–∫—Ä–∏–Ω—à–æ—Ç ===
//     console.log('üì∏ Taking screenshot...');
//     await page.screenshot({ path: 'screenshot.jpg', fullPage: true, type: 'jpeg', quality: 90 });
//     console.log('‚úÖ Screenshot saved: screenshot.jpg\n');

//   } catch (err) {
//     console.error('\n‚ùå Parser failed:', err.message);
//     const html = await page.content().catch(() => null);
//     if (html) fs.writeFileSync('error-page.html', html);
//     throw err;
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed\n');
//   }
// })()
// .then(() => { console.log('‚úÖ Parser completed successfully!'); process.exit(0); })
// .catch((err) => { console.error('üí• Critical error:', err.message); process.exit(1); });









// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

// // === –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ===
// const [, , productUrl, targetRegionRaw] = process.argv;

// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteer.js <PRODUCT_URL> <REGION>');
//   console.error('Example: node puppeteer.js "https://www.vprok.ru/product/..." "–ú–æ—Å–∫–≤–∞ –∏ –æ–±–ª–∞—Å—Ç—å"');
//   process.exit(1);
// }

// const targetRegion = targetRegionRaw.trim();

// // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Cloudflare / anti-bot ===
// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(() => '');
  
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è  Detected anti-bot check page. Waiting...');

//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(() => '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed\n');
//       return true;
//     }
//   }

//   console.error(`‚ùå Anti-bot check timeout after ${timeoutSec}s`);
//   fs.writeFileSync('cloudflare-page.html', html);
//   return false;
// }

// // === –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
// async function selectRegion(page, targetRegion) {
//   console.log(`üîÑ Attempting to select region: "${targetRegion}"`);
  
//   const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
//   const normalizedTarget = normalize(targetRegion);

//   try {
//     // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–∏–æ–Ω
//     const currentRegion = await page.$eval(
//       'button[class^="Region_region__"] .Region_text__Wm7FO',
//       el => el.textContent.trim()
//     ).catch(() => null);

//     console.log(`üìç Current region: "${currentRegion || 'unknown'}"`);

//     if (currentRegion && normalize(currentRegion) === normalizedTarget) {
//       console.log(`‚úÖ Region already correct!\n`);
//       return true;
//     }

//     // 2. –ö–ª–∏–∫–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞
//     console.log('üñ±Ô∏è  Clicking region button...');
//     await page.click('button[class^="Region_region__"]');
    
//     // 3. –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
//     console.log('‚è≥ Waiting for modal...');
//     await sleep(1500);

//     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ—è–≤–∏–ª–æ—Å—å
//     const modalVisible = await page.evaluate(() => {
//       const modal = document.querySelector('div[role="dialog"]');
//       return modal && modal.offsetParent !== null;
//     });

//     if (!modalVisible) {
//       console.error('‚ùå Modal did not appear');
//       return false;
//     }

//     console.log('‚úì Modal opened');

//     // 4. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
//     const regions = await page.$$eval(
//       'div[class^="UiRegionListBase_listWrapper__"] ul li button',
//       buttons => buttons.map(btn => btn.textContent.trim())
//     );

//     console.log(`‚úì Found ${regions.length} regions:`, regions);

//     // 5. –ò—â–µ–º –∏ –∫–ª–∏–∫–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–µ–≥–∏–æ–Ω
//     const clicked = await page.evaluate((target) => {
//       // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ evaluate
//       const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
      
//       const buttons = document.querySelectorAll('div[class^="UiRegionListBase_listWrapper__"] ul li button');
//       const normalizedTarget = normalize(target);
      
//       for (const button of buttons) {
//         const text = button.textContent.trim();
//         const normalizedText = normalize(text);
        
//         console.log('Comparing:', normalizedText, '===', normalizedTarget);
        
//         if (normalizedText === normalizedTarget || normalizedText.includes(normalizedTarget)) {
//           console.log('MATCH! Clicking:', text);
//           button.click();
//           return text;
//         }
//       }
//       return null;
//     }, targetRegion);

//     if (!clicked) {
//       console.error(`‚ùå Region "${targetRegion}" not found in list`);
//       return false;
//     }

//     console.log(`‚úÖ Clicked region: "${clicked}"`);

//     // 6. –ñ–¥–µ–º –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
//     await sleep(3000);

//     // 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–≥–∏–æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
//     const newRegion = await page.$eval(
//       'button[class^="Region_region__"] .Region_text__Wm7FO',
//       el => el.textContent.trim()
//     ).catch(() => null);

//     if (newRegion && normalize(newRegion) === normalizedTarget) {
//       console.log(`‚úÖ Region verified: "${newRegion}"\n`);
//       return true;
//     } else {
//       console.warn(`‚ö†Ô∏è  Region verification failed. Got: "${newRegion}"\n`);
//       return false;
//     }

//   } catch (error) {
//     console.error(`‚ùå Failed to select region: ${error.message}\n`);
//     return false;
//   }
// }

// // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–µ ===
// async function extractProductData(page) {
//   console.log('üìä Extracting product data...\n');

//   const productData = await page.evaluate(() => {
//     const result = {
//       price: null,
//       priceOld: null,
//       rating: null,
//       reviewCount: null,
//       debug: {}
//     };

//     const extractNumber = (text) => {
//       if (!text) return null;
//       const cleaned = text.replace(/\s+/g, '').replace(',', '.');
//       const match = cleaned.match(/[\d]+\.?[\d]*/);
//       return match ? parseFloat(match[0]) : null;
//     };

//     // === –ù–ê–•–û–î–ò–ú –ö–û–ù–¢–ï–ô–ù–ï–† –û–°–ù–û–í–ù–û–ì–û –¢–û–í–ê–†–ê ===
//     console.log('Looking for product container...');
    
//     // –ò—â–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ–≤–∞—Ä–∞ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
//     const productContainer = document.querySelector(
//       '[class*="ProductPage"], [class*="ProductCard"], main, [class*="product-info"]'
//     );
    
//     if (!productContainer) {
//       console.warn('Product container not found, searching in full document');
//     } else {
//       console.log('Product container found:', productContainer.className);
//     }
    
//     // –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞ - –ª–∏–±–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ–≤–∞—Ä–∞, –ª–∏–±–æ –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç
//     const searchContext = productContainer || document;

//     // === –¶–ï–ù–ê ===
//     console.log('Looking for price...');
//     const priceSelectors = [
//       '.Price_price__3rj7L',
//       '[class*="Price_price"]:not([class*="old"])',
//       '[data-testid="product-price"]',
//       'span[class*="price"]:not([class*="old"])'
//     ];

//     for (const selector of priceSelectors) {
//       const el = searchContext.querySelector(selector);
//       if (el && el.textContent.includes('‚ÇΩ')) {
//         const price = extractNumber(el.textContent);
//         if (price && price > 0 && price < 1000000) {
//           result.price = price;
//           result.debug.priceSelector = selector;
//           console.log('Found price:', price, 'via', selector);
//           break;
//         }
//       }
//     }

//     // === –°–¢–ê–†–ê–Ø –¶–ï–ù–ê ===
//     console.log('Looking for old price...');
    
//     // –í–ê–ñ–ù–û: –ò—â–µ–º –¢–û–õ–¨–ö–û –≤ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
//     if (result.price) {
//       // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–æ–π
//       let priceElement = null;
//       for (const selector of priceSelectors) {
//         priceElement = searchContext.querySelector(selector);
//         if (priceElement) break;
//       }
      
//       if (priceElement) {
//         // –ò—â–µ–º —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
//         const priceContainer = priceElement.closest('[class*="Price"], [class*="price"]');
        
//         if (priceContainer) {
//           console.log('Searching old price in price container only');
          
//           // –ò—â–µ–º –∑–∞—á–µ—Ä–∫–Ω—É—Ç—É—é —Ü–µ–Ω—É –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
//           const oldPriceSelectors = [
//             '.Price_oldPrice__1mNRO',
//             '[class*="Price_oldPrice"]',
//             '[class*="oldPrice"]',
//             's',
//             'del'
//           ];
          
//           for (const selector of oldPriceSelectors) {
//             const el = priceContainer.querySelector(selector);
//             if (el && el.textContent.includes('‚ÇΩ')) {
//               const oldPrice = extractNumber(el.textContent);
//               if (oldPrice && oldPrice > result.price) {
//                 result.priceOld = oldPrice;
//                 result.debug.priceOldSelector = selector + ' (in price container)';
//                 console.log('Found old price:', oldPrice, 'via', selector);
//                 break;
//               }
//             }
//           }
          
//           // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —Å—Ç–∏–ª—é line-through
//           if (!result.priceOld) {
//             const allInContainer = priceContainer.querySelectorAll('span, div');
//             for (const el of allInContainer) {
//               const style = window.getComputedStyle(el);
//               if (style.textDecoration.includes('line-through') && el.textContent.includes('‚ÇΩ')) {
//                 const oldPrice = extractNumber(el.textContent);
//                 if (oldPrice && oldPrice > result.price) {
//                   result.priceOld = oldPrice;
//                   result.debug.priceOldSelector = 'line-through (in price container)';
//                   console.log('Found old price:', oldPrice, 'via line-through style');
//                   break;
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
    
//     if (!result.priceOld) {
//       console.log('Old price not found (product may not have discount)');
//     }

//     // === –†–ï–ô–¢–ò–ù–ì ===
//     console.log('Looking for rating...');
    
//     // –°–ø–æ—Å–æ–± 1: –ò—â–µ–º –ø–æ –∫–ª–∞—Å—Å–∞–º
//     const ratingSelectors = [
//       '.Rating_rating__1KFrt',
//       '[class*="Rating_rating"]',
//       '[class*="rating"]',
//       '[data-testid="product-rating"]',
//       '[itemprop="ratingValue"]'
//     ];

//     for (const selector of ratingSelectors) {
//       const el = document.querySelector(selector);
//       if (el) {
//         const text = el.textContent.trim();
//         // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∏–¥–∞ "4.8" –∏–ª–∏ "4,8"
//         const match = text.match(/([0-5])[.,](\d)/);
//         if (match) {
//           const rating = parseFloat(match[0].replace(',', '.'));
//           if (rating >= 0 && rating <= 5) {
//             result.rating = rating;
//             result.debug.ratingSelector = selector;
//             console.log('Found rating:', rating, 'via', selector);
//             break;
//           }
//         }
//       }
//     }

//     // –°–ø–æ—Å–æ–± 2: –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∏ –æ—Ç–∑—ã–≤–∞–º–∏
//     if (result.rating === null) {
//       const reviewContainers = document.querySelectorAll('[class*="Review"], [class*="rating"]');
//       for (const container of reviewContainers) {
//         const text = container.textContent;
//         // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω: —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 5 —Å —Ç–æ—á–∫–æ–π
//         const match = text.match(/([0-5])[.,](\d)/);
//         if (match) {
//           const rating = parseFloat(match[0].replace(',', '.'));
//           if (rating >= 0 && rating <= 5) {
//             result.rating = rating;
//             result.debug.ratingSelector = 'review container';
//             console.log('Found rating:', rating, 'in review container');
//             break;
//           }
//         }
//       }
//     }

//     // –°–ø–æ—Å–æ–± 3: –ò—â–µ–º SVG —Å–æ –∑–≤–µ–∑–¥–∞–º–∏ –∏ —á–∏—Å–ª–æ —Ä—è–¥–æ–º
//     if (result.rating === null) {
//       const svgStars = document.querySelectorAll('svg');
//       for (const svg of svgStars) {
//         // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∑–≤–µ–∑–¥—ã
//         const parent = svg.closest('div, span');
//         if (parent) {
//           const text = parent.textContent;
//           const match = text.match(/([0-5])[.,](\d)/);
//           if (match) {
//             const rating = parseFloat(match[0].replace(',', '.'));
//             if (rating >= 0 && rating <= 5) {
//               result.rating = rating;
//               result.debug.ratingSelector = 'near stars';
//               console.log('Found rating:', rating, 'near stars');
//               break;
//             }
//           }
//         }
//       }
//     }

//     // === –ö–û–õ–ò–ß–ï–°–¢–í–û –û–¢–ó–´–í–û–í ===
//     console.log('Looking for review count...');
    
//     // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º –í –ö–û–ù–¢–ï–ô–ù–ï–†–ï –¢–û–í–ê–†–ê
//     const reviewSelectors = [
//       '.Review_count__2nFJx',
//       '[class*="Review_count"]',
//       '[data-testid="product-review-count"]',
//       '[itemprop="reviewCount"]'
//     ];

//     for (const selector of reviewSelectors) {
//       const el = searchContext.querySelector(selector);
//       if (el) {
//         const text = el.textContent.trim();
//         const count = extractNumber(text);
        
//         // –í–ê–ñ–ù–û: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ - —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –æ–±—ã—á–Ω–æ > 0
//         if (count !== null && Number.isInteger(count) && count >= 0 && count < 100000) {
//           result.reviewCount = Math.floor(count);
//           result.debug.reviewSelector = selector;
//           console.log('Found review count:', count, 'via', selector);
//           break;
//         }
//       }
//     }

//     // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ - –∏—â–µ–º —Å—Å—ã–ª–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º "–æ—Ç–∑—ã–≤" –í –ö–û–ù–¢–ï–ô–ù–ï–†–ï –¢–û–í–ê–†–ê
//     if (result.reviewCount === null) {
//       const reviewLinks = searchContext.querySelectorAll('a[href*="review"], button');
//       for (const el of reviewLinks) {
//         const text = el.textContent.toLowerCase();
        
//         // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å —Å–ª–æ–≤–æ "–æ—Ç–∑—ã–≤" –ò —á–∏—Å–ª–æ
//         if (text.includes('–æ—Ç–∑—ã–≤') && text.match(/\d+/)) {
//           const numbers = text.match(/\d+/g);
          
//           if (numbers && numbers.length > 0) {
//             // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ
//             const count = parseInt(numbers[0]);
            
//             // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ —Ä–µ–π—Ç–∏–Ω–≥ (–Ω–µ –æ—Ç 0 –¥–æ 5) –∏ –Ω–µ ID —Ç–æ–≤–∞—Ä–∞ (–Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ)
//             if (count > 5 && count < 100000) {
//               result.reviewCount = count;
//               result.debug.reviewSelector = 'link with "–æ—Ç–∑—ã–≤" (in product container)';
//               console.log('Found review count:', count, 'via text search');
//               break;
//             }
//           }
//         }
//       }
//     }
    
//     if (!result.reviewCount) {
//       console.log('Review count not found');
//     }

//     return result;
//   });

//   // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
//   console.log('üìä Extraction results:');
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  
//   if (productData.price !== null) {
//     console.log(`‚úÖ Price: ${productData.price} ‚ÇΩ`);
//     console.log(`   Selector: ${productData.debug.priceSelector}`);
//   } else {
//     console.log(`‚ùå Price: NOT FOUND`);
//   }

//   if (productData.priceOld !== null) {
//     console.log(`‚úÖ Old price: ${productData.priceOld} ‚ÇΩ`);
//     console.log(`   Selector: ${productData.debug.priceOldSelector}`);
//   } else {
//     console.log(`‚ö™ Old price: not found (no discount)`);
//   }

//   if (productData.rating !== null) {
//     console.log(`‚úÖ Rating: ${productData.rating} / 5.0`);
//     console.log(`   Selector: ${productData.debug.ratingSelector}`);
//   } else {
//     console.log(`‚ùå Rating: NOT FOUND`);
//   }

//   if (productData.reviewCount !== null) {
//     console.log(`‚úÖ Review count: ${productData.reviewCount}`);
//     console.log(`   Selector: ${productData.debug.reviewSelector}`);
//   } else {
//     console.log(`‚ùå Review count: NOT FOUND`);
//   }
  
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');

//   return productData;
// }

// // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
// (async () => {
//   console.log('üöÄ Starting parser...');
//   console.log(`üì¶ Product URL: ${productUrl}`);
//   console.log(`üåç Target region: ${targetRegion}\n`);

//   const browser = await puppeteer.launch({
//     headless: false,
//     args: [
//       '--no-sandbox',
//       '--disable-setuid-sandbox',
//       '--start-maximized',
//       '--disable-blink-features=AutomationControlled'
//     ],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   await page.setUserAgent(
//     'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
//   );
//   page.setDefaultTimeout(30000);

//   // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
//   page.on('console', msg => {
//     const text = msg.text();
//     if (text.includes('Looking for') || text.includes('Found')) {
//       console.log(`   [Browser] ${text}`);
//     }
//   });

//   try {
//     // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
//     console.log('üåê Loading product page...');
//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded\n');

//     // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Cloudflare
//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) {
//       throw new Error('Anti-bot check failed');
//     }

//     // 3. –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
//     await sleep(2000);

//     // 4. –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏–æ–Ω
//     const regionSuccess = await selectRegion(page, targetRegion);
//     if (!regionSuccess) {
//       console.warn('‚ö†Ô∏è  Region selection failed, but continuing...\n');
//     }

//     // 5. –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞
//     console.log('‚è≥ Waiting for product data to load...');
//     await sleep(3000);

//     // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∂–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã
//     try {
//       await page.waitForSelector('.Price_price__3rj7L, [class*="Price_price"]', { 
//         timeout: 10000,
//         visible: true 
//       });
//       console.log('‚úì Price element visible\n');
//     } catch (e) {
//       console.warn('‚ö†Ô∏è  Price element not found, continuing...\n');
//     }

//     // 6. –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ
//     const productData = await extractProductData(page);

//     // –ï—Å–ª–∏ —Ä–µ–π—Ç–∏–Ω–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–µ–ª–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
//     if (!productData.rating) {
//       console.log('\nüîç DEBUG: Rating not found, analyzing page structure...');
      
//       const debugInfo = await page.evaluate(() => {
//         const info = {
//           ratingClasses: [],
//           reviewElements: [],
//           numbersFound: []
//         };
        
//         // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å "rating" –≤ –∫–ª–∞—Å—Å–µ
//         const ratingElements = document.querySelectorAll('[class*="rating"], [class*="Rating"]');
//         ratingElements.forEach(el => {
//           info.ratingClasses.push({
//             tag: el.tagName,
//             class: el.className,
//             text: el.textContent.trim().substring(0, 50)
//           });
//         });
        
//         // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å "review" –≤ –∫–ª–∞—Å—Å–µ
//         const reviewElements = document.querySelectorAll('[class*="review"], [class*="Review"]');
//         reviewElements.forEach(el => {
//           info.reviewElements.push({
//             tag: el.tagName,
//             class: el.className,
//             text: el.textContent.trim().substring(0, 100)
//           });
//         });
        
//         // –ò—â–µ–º –≤—Å–µ —á–∏—Å–ª–∞ –æ—Ç 0 –¥–æ 5 —Å —Ç–æ—á–∫–æ–π
//         const allText = document.body.innerText;
//         const matches = allText.match(/[0-5]\.[0-9]/g);
//         if (matches) {
//           info.numbersFound = [...new Set(matches)];
//         }
        
//         return info;
//       });
      
//       console.log('Elements with "rating" class:', debugInfo.ratingClasses);
//       console.log('Elements with "review" class:', debugInfo.reviewElements);
//       console.log('Numbers 0-5 with decimal found on page:', debugInfo.numbersFound);
//       console.log('');
//     }

//     // 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª product.txt
//     console.log('üíæ Saving data to product.txt...');

//     const outputLines = [];
//     if (productData.price !== null) outputLines.push(`price=${productData.price}`);
//     if (productData.priceOld !== null) outputLines.push(`priceOld=${productData.priceOld}`);
//     if (productData.rating !== null) outputLines.push(`rating=${productData.rating}`);
//     if (productData.reviewCount !== null) outputLines.push(`reviewCount=${productData.reviewCount}`);

//     if (outputLines.length > 0) {
//       const content = outputLines.join('\n');
//       fs.writeFileSync('product.txt', content);
//       console.log('‚úÖ Saved to product.txt\n');
//       console.log('üìÑ File content:');
//       console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
//       console.log(content);
//       console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
//     } else {
//       console.warn('‚ö†Ô∏è  No data extracted!\n');
//       const html = await page.content();
//       fs.writeFileSync('debug.html', html);
//       console.log('üîç Saved debug.html for inspection\n');
//     }

//     // 8. –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç
//     console.log('üì∏ Taking screenshot...');
//     await page.screenshot({
//       path: 'screenshot.jpg',
//       fullPage: true,
//       type: 'jpeg',
//       quality: 90
//     });
//     console.log('‚úÖ Screenshot saved: screenshot.jpg\n');

//   } catch (err) {
//     console.error('\n‚ùå Parser failed:', err.message);
//     console.error(err.stack);
    
//     try {
//       const html = await page.content().catch(() => null);
//       if (html) {
//         fs.writeFileSync('error-page.html', html);
//         console.log('üîç Saved error-page.html for debugging\n');
//       }
//     } catch {}
    
//     throw err;
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed\n');
//   }
// })()
//   .then(() => {
//     console.log('‚úÖ Parser completed successfully!');
//     process.exit(0);
//   })
//   .catch((err) => {
//     console.error('üí• Critical error:', err.message);
//     process.exit(1);
//   });








// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

// // === –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ===
// const [, , productUrl, targetRegionRaw] = process.argv;

// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteer.js <PRODUCT_URL> <REGION>');
//   console.error('Example: node puppeteer.js "https://www.vprok.ru/product/..." "–ú–æ—Å–∫–≤–∞ –∏ –æ–±–ª–∞—Å—Ç—å"');
//   process.exit(1);
// }

// const targetRegion = targetRegionRaw.trim();

// // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Cloudflare / anti-bot ===
// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(() => '');
  
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è  Detected anti-bot check page. Waiting...');

//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(() => '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed\n');
//       return true;
//     }
//   }

//   console.error(`‚ùå Anti-bot check timeout after ${timeoutSec}s`);
//   fs.writeFileSync('cloudflare-page.html', html);
//   return false;
// }

// // === –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
// async function selectRegion(page, targetRegion) {
//   console.log(`üîÑ Attempting to select region: "${targetRegion}"`);
  
//   const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
//   const normalizedTarget = normalize(targetRegion);

//   try {
//     // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–∏–æ–Ω
//     const currentRegion = await page.$eval(
//       'button[class^="Region_region__"] .Region_text__Wm7FO',
//       el => el.textContent.trim()
//     ).catch(() => null);

//     console.log(`üìç Current region: "${currentRegion || 'unknown'}"`);

//     if (currentRegion && normalize(currentRegion) === normalizedTarget) {
//       console.log(`‚úÖ Region already correct!\n`);
//       return true;
//     }

//     // 2. –ö–ª–∏–∫–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞
//     console.log('üñ±Ô∏è  Clicking region button...');
//     await page.click('button[class^="Region_region__"]');
    
//     // 3. –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
//     console.log('‚è≥ Waiting for modal...');
//     await sleep(1500);

//     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ—è–≤–∏–ª–æ—Å—å
//     const modalVisible = await page.evaluate(() => {
//       const modal = document.querySelector('div[role="dialog"]');
//       return modal && modal.offsetParent !== null;
//     });

//     if (!modalVisible) {
//       console.error('‚ùå Modal did not appear');
//       return false;
//     }

//     console.log('‚úì Modal opened');

//     // 4. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
//     const regions = await page.$$eval(
//       'div[class^="UiRegionListBase_listWrapper__"] ul li button',
//       buttons => buttons.map(btn => btn.textContent.trim())
//     );

//     console.log(`‚úì Found ${regions.length} regions:`, regions);

//     // 5. –ò—â–µ–º –∏ –∫–ª–∏–∫–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–µ–≥–∏–æ–Ω
//     const clicked = await page.evaluate((target) => {
//       // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ evaluate
//       const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
      
//       const buttons = document.querySelectorAll('div[class^="UiRegionListBase_listWrapper__"] ul li button');
//       const normalizedTarget = normalize(target);
      
//       for (const button of buttons) {
//         const text = button.textContent.trim();
//         const normalizedText = normalize(text);
        
//         console.log('Comparing:', normalizedText, '===', normalizedTarget);
        
//         if (normalizedText === normalizedTarget || normalizedText.includes(normalizedTarget)) {
//           console.log('MATCH! Clicking:', text);
//           button.click();
//           return text;
//         }
//       }
//       return null;
//     }, targetRegion);

//     if (!clicked) {
//       console.error(`‚ùå Region "${targetRegion}" not found in list`);
//       return false;
//     }

//     console.log(`‚úÖ Clicked region: "${clicked}"`);

//     // 6. –ñ–¥–µ–º –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
//     await sleep(3000);

//     // 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–≥–∏–æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
//     const newRegion = await page.$eval(
//       'button[class^="Region_region__"] .Region_text__Wm7FO',
//       el => el.textContent.trim()
//     ).catch(() => null);

//     if (newRegion && normalize(newRegion) === normalizedTarget) {
//       console.log(`‚úÖ Region verified: "${newRegion}"\n`);
//       return true;
//     } else {
//       console.warn(`‚ö†Ô∏è  Region verification failed. Got: "${newRegion}"\n`);
//       return false;
//     }

//   } catch (error) {
//     console.error(`‚ùå Failed to select region: ${error.message}\n`);
//     return false;
//   }
// }

// // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–µ ===
// async function extractProductData(page) {
//   console.log('üìä Extracting product data...\n');

//   const productData = await page.evaluate(() => {
//     const result = {
//       price: null,
//       priceOld: null,
//       rating: null,
//       reviewCount: null,
//       debug: {}
//     };

//     const extractNumber = (text) => {
//       if (!text) return null;
//       const cleaned = text.replace(/\s+/g, '').replace(',', '.');
//       const match = cleaned.match(/[\d]+\.?[\d]*/);
//       return match ? parseFloat(match[0]) : null;
//     };

//     // === –¶–ï–ù–ê ===
//     console.log('Looking for price...');
//     const priceSelectors = [
//       '.Price_price__3rj7L',
//       '[class*="Price_price"]:not([class*="old"])',
//       '[data-testid="product-price"]',
//       'span[class*="price"]:not([class*="old"])'
//     ];

//     for (const selector of priceSelectors) {
//       const el = document.querySelector(selector);
//       if (el && el.textContent.includes('‚ÇΩ')) {
//         const price = extractNumber(el.textContent);
//         if (price && price > 0 && price < 1000000) {
//           result.price = price;
//           result.debug.priceSelector = selector;
//           console.log('Found price:', price, 'via', selector);
//           break;
//         }
//       }
//     }

//     // === –°–¢–ê–†–ê–Ø –¶–ï–ù–ê ===
//     console.log('Looking for old price...');
//     const oldPriceSelectors = [
//       '.Price_oldPrice__1mNRO',
//       '[class*="Price_oldPrice"]',
//       '[data-testid="product-price-old"]',
//       's',
//       'del'
//     ];

//     for (const selector of oldPriceSelectors) {
//       const el = document.querySelector(selector);
//       if (el && el.textContent.includes('‚ÇΩ')) {
//         const oldPrice = extractNumber(el.textContent);
//         if (oldPrice && oldPrice > (result.price || 0)) {
//           result.priceOld = oldPrice;
//           result.debug.priceOldSelector = selector;
//           console.log('Found old price:', oldPrice, 'via', selector);
//           break;
//         }
//       }
//     }

//     // === –†–ï–ô–¢–ò–ù–ì ===
//     console.log('Looking for rating...');
//     const ratingSelectors = [
//       '.Rating_rating__1KFrt',
//       '[class*="Rating_rating"]',
//       '[data-testid="product-rating"]',
//       '[itemprop="ratingValue"]'
//     ];

//     for (const selector of ratingSelectors) {
//       const el = document.querySelector(selector);
//       if (el) {
//         const text = el.textContent.trim();
//         const rating = extractNumber(text);
        
//         // –í–ê–ñ–ù–û: —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ç 0 –¥–æ 5
//         if (rating !== null && rating >= 0 && rating <= 5) {
//           result.rating = rating;
//           result.debug.ratingSelector = selector;
//           console.log('Found rating:', rating, 'via', selector);
//           break;
//         }
//       }
//     }

//     // === –ö–û–õ–ò–ß–ï–°–¢–í–û –û–¢–ó–´–í–û–í ===
//     console.log('Looking for review count...');
    
//     // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º
//     const reviewSelectors = [
//       '.Review_count__2nFJx',
//       '[class*="Review_count"]',
//       '[data-testid="product-review-count"]',
//       '[itemprop="reviewCount"]'
//     ];

//     for (const selector of reviewSelectors) {
//       const el = document.querySelector(selector);
//       if (el) {
//         const text = el.textContent.trim();
//         const count = extractNumber(text);
        
//         // –í–ê–ñ–ù–û: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ - —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –æ–±—ã—á–Ω–æ > 0
//         if (count !== null && Number.isInteger(count) && count >= 0 && count < 100000) {
//           result.reviewCount = Math.floor(count);
//           result.debug.reviewSelector = selector;
//           console.log('Found review count:', count, 'via', selector);
//           break;
//         }
//       }
//     }

//     // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ - –∏—â–µ–º —Å—Å—ã–ª–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º "–æ—Ç–∑—ã–≤"
//     if (result.reviewCount === null) {
//       const reviewLinks = document.querySelectorAll('a[href*="review"], button');
//       for (const el of reviewLinks) {
//         const text = el.textContent.toLowerCase();
        
//         // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å —Å–ª–æ–≤–æ "–æ—Ç–∑—ã–≤" –ò —á–∏—Å–ª–æ
//         if (text.includes('–æ—Ç–∑—ã–≤') && text.match(/\d+/)) {
//           const numbers = text.match(/\d+/g);
          
//           if (numbers && numbers.length > 0) {
//             // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ
//             const count = parseInt(numbers[0]);
            
//             // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ —Ä–µ–π—Ç–∏–Ω–≥ (–Ω–µ –æ—Ç 0 –¥–æ 5) –∏ –Ω–µ ID —Ç–æ–≤–∞—Ä–∞ (–Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ)
//             if (count > 5 && count < 100000) {
//               result.reviewCount = count;
//               result.debug.reviewSelector = 'link with "–æ—Ç–∑—ã–≤"';
//               console.log('Found review count:', count, 'via text search');
//               break;
//             }
//           }
//         }
//       }
//     }

//     return result;
//   });

//   // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
//   console.log('üìä Extraction results:');
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  
//   if (productData.price !== null) {
//     console.log(`‚úÖ Price: ${productData.price} ‚ÇΩ`);
//     console.log(`   Selector: ${productData.debug.priceSelector}`);
//   } else {
//     console.log(`‚ùå Price: NOT FOUND`);
//   }

//   if (productData.priceOld !== null) {
//     console.log(`‚úÖ Old price: ${productData.priceOld} ‚ÇΩ`);
//     console.log(`   Selector: ${productData.debug.priceOldSelector}`);
//   } else {
//     console.log(`‚ö™ Old price: not found (no discount)`);
//   }

//   if (productData.rating !== null) {
//     console.log(`‚úÖ Rating: ${productData.rating} / 5.0`);
//     console.log(`   Selector: ${productData.debug.ratingSelector}`);
//   } else {
//     console.log(`‚ùå Rating: NOT FOUND`);
//   }

//   if (productData.reviewCount !== null) {
//     console.log(`‚úÖ Review count: ${productData.reviewCount}`);
//     console.log(`   Selector: ${productData.debug.reviewSelector}`);
//   } else {
//     console.log(`‚ùå Review count: NOT FOUND`);
//   }
  
//   console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');

//   return productData;
// }

// // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
// (async () => {
//   console.log('üöÄ Starting parser...');
//   console.log(`üì¶ Product URL: ${productUrl}`);
//   console.log(`üåç Target region: ${targetRegion}\n`);

//   const browser = await puppeteer.launch({
//     headless: false,
//     args: [
//       '--no-sandbox',
//       '--disable-setuid-sandbox',
//       '--start-maximized',
//       '--disable-blink-features=AutomationControlled'
//     ],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   await page.setUserAgent(
//     'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
//   );
//   page.setDefaultTimeout(30000);

//   // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
//   page.on('console', msg => {
//     const text = msg.text();
//     if (text.includes('Looking for') || text.includes('Found')) {
//       console.log(`   [Browser] ${text}`);
//     }
//   });

//   try {
//     // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
//     console.log('üåê Loading product page...');
//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded\n');

//     // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Cloudflare
//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) {
//       throw new Error('Anti-bot check failed');
//     }

//     // 3. –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
//     await sleep(2000);

//     // 4. –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏–æ–Ω
//     const regionSuccess = await selectRegion(page, targetRegion);
//     if (!regionSuccess) {
//       console.warn('‚ö†Ô∏è  Region selection failed, but continuing...\n');
//     }

//     // 5. –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞
//     console.log('‚è≥ Waiting for product data to load...');
//     await sleep(3000);

//     // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∂–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã
//     try {
//       await page.waitForSelector('.Price_price__3rj7L, [class*="Price_price"]', { 
//         timeout: 10000,
//         visible: true 
//       });
//       console.log('‚úì Price element visible\n');
//     } catch (e) {
//       console.warn('‚ö†Ô∏è  Price element not found, continuing...\n');
//     }

//     // 6. –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ
//     const productData = await extractProductData(page);

//     // 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª product.txt
//     console.log('üíæ Saving data to product.txt...');

//     const outputLines = [];
//     if (productData.price !== null) outputLines.push(`price=${productData.price}`);
//     if (productData.priceOld !== null) outputLines.push(`priceOld=${productData.priceOld}`);
//     if (productData.rating !== null) outputLines.push(`rating=${productData.rating}`);
//     if (productData.reviewCount !== null) outputLines.push(`reviewCount=${productData.reviewCount}`);

//     if (outputLines.length > 0) {
//       const content = outputLines.join('\n');
//       fs.writeFileSync('product.txt', content);
//       console.log('‚úÖ Saved to product.txt\n');
//       console.log('üìÑ File content:');
//       console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
//       console.log(content);
//       console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
//     } else {
//       console.warn('‚ö†Ô∏è  No data extracted!\n');
//       const html = await page.content();
//       fs.writeFileSync('debug.html', html);
//       console.log('üîç Saved debug.html for inspection\n');
//     }

//     // 8. –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç
//     console.log('üì∏ Taking screenshot...');
//     await page.screenshot({
//       path: 'screenshot.jpg',
//       fullPage: true,
//       type: 'jpeg',
//       quality: 90
//     });
//     console.log('‚úÖ Screenshot saved: screenshot.jpg\n');

//   } catch (err) {
//     console.error('\n‚ùå Parser failed:', err.message);
//     console.error(err.stack);
    
//     try {
//       const html = await page.content().catch(() => null);
//       if (html) {
//         fs.writeFileSync('error-page.html', html);
//         console.log('üîç Saved error-page.html for debugging\n');
//       }
//     } catch {}
    
//     throw err;
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed\n');
//   }
// })()
//   .then(() => {
//     console.log('‚úÖ Parser completed successfully!');
//     process.exit(0);
//   })
//   .catch((err) => {
//     console.error('üí• Critical error:', err.message);
//     process.exit(1);
//   });





// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

// // === –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ===
// const [, , productUrl, targetRegionRaw] = process.argv;

// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteer.js <PRODUCT_URL> <REGION>');
//   console.error('Example: node puppeteer.js "https://www.vprok.ru/product/..." "–ú–æ—Å–∫–≤–∞ –∏ –æ–±–ª–∞—Å—Ç—å"');
//   process.exit(1);
// }

// const targetRegion = targetRegionRaw.trim();

// // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Cloudflare / anti-bot ===
// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(() => '');
  
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è  Detected anti-bot check page. Waiting...');

//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(() => '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed\n');
//       return true;
//     }
//   }

//   console.error(`‚ùå Anti-bot check timeout after ${timeoutSec}s`);
//   fs.writeFileSync('cloudflare-page.html', html);
//   return false;
// }

// // === –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ===
// async function applyRegionViaModal(page, targetRegion, { retries = 3 } = {}) {
//   const norm = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
//   const normTarget = norm(targetRegion);

//   console.log(`üîÑ Attempting to select region: "${targetRegion}"`);

//   for (let attempt = 1; attempt <= retries; attempt++) {
//     console.log(`   ‚ñ∂ Attempt ${attempt}/${retries}`);

//     // 1. –ò—â–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞ –≤ —Ö–µ–¥–µ—Ä–µ
//     const regionButtonSelector = 'button[class^="Region_region__"]';
//     const btn = await page.$(regionButtonSelector).catch(() => null);
    
//     if (!btn) {
//       console.warn('   ‚ö†Ô∏è  Region button not found in header');
//       await sleep(1200);
//       continue;
//     }

//     console.log('   ‚úì Region button found');

//     // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–∏–æ–Ω
//     const currentRegion = await page.$eval(
//       `${regionButtonSelector} .Region_text__Wm7FO`,
//       el => el.textContent.trim()
//     ).catch(() => null);

//     console.log(`   üìç Current region: "${currentRegion || 'unknown'}"`);

//     // –ï—Å–ª–∏ —Ä–µ–≥–∏–æ–Ω —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –≤—ã—Ö–æ–¥–∏–º
//     if (currentRegion && norm(currentRegion) === normTarget) {
//       console.log(`   ‚úÖ Region already correct!\n`);
//       return true;
//     }

//     // 2. –ö–ª–∏–∫–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞
//     console.log('   üñ±Ô∏è  Clicking region button...');
//     await btn.click({ delay: 100 });
//     await sleep(800);

//     // 3. –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
//     console.log('   ‚è≥ Waiting for modal...');
//     const modalRegionSelector = 'div[class^="UiRegionListBase_listWrapper__"] ul li button';
    
//     await page.waitForSelector(modalRegionSelector, { timeout: 3000 }).catch(() => null);
//     const regionButtons = await page.$$(modalRegionSelector);

//     if (!regionButtons || !regionButtons.length) {
//       console.warn('   ‚ö†Ô∏è  Modal not found or empty ‚Äî retrying...');
//       await sleep(1000);
//       continue;
//     }

//     console.log(`   ‚úì Modal opened, found ${regionButtons.length} regions`);

//     // 4. –ò—â–µ–º –Ω—É–∂–Ω—ã–π —Ä–µ–≥–∏–æ–Ω –≤ —Å–ø–∏—Å–∫–µ
//     console.log(`   üîç Searching for "${targetRegion}"...`);
    
//     let clicked = false;
//     for (const button of regionButtons) {
//       const text = await page.evaluate(el => el.innerText.trim(), button);
      
//       if (norm(text) === normTarget || norm(text).includes(normTarget)) {
//         console.log(`   ‚úì Found: "${text}"`);
//         await button.click({ delay: 100 });
//         clicked = true;
//         console.log(`   ‚úÖ Clicked!`);
//         break;
//       }
//     }

//     if (!clicked) {
//       console.warn(`   ‚ö†Ô∏è  Target region not found in list ‚Äî retrying...`);
//       await sleep(1000);
//       continue;
//     }

//     // 5. –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
//     await sleep(1500);

//     // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–≥–∏–æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
//     const headerText = await page.$eval(
//       regionButtonSelector,
//       el => el.innerText.trim()
//     ).catch(() => null);

//     if (headerText && norm(headerText).includes(normTarget)) {
//       console.log(`   ‚úÖ Region verified in header: "${headerText}"\n`);
//       return true;
//     }

//     console.warn('   ‚ö†Ô∏è  Region not verified ‚Äî retrying...');
//     await sleep(1000);
//   }

//   console.error('‚ùå Failed to apply region after all attempts\n');
//   return false;
// }

// // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–µ ===
// async function extractProductData(page) {
//   console.log('üìä Extracting product data...');

//   const htmlData = await page.evaluate(() => {
//     const result = {
//       price: null,
//       priceOld: null,
//       rating: null,
//       reviewCount: null,
//       debug: {
//         priceSelector: null,
//         priceOldSelector: null,
//         ratingSelector: null,
//         reviewSelector: null
//       }
//     };

//     // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ —Å–ø–∏—Å–∫—É —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
//     const findElement = (selectors) => {
//       for (const selector of selectors) {
//         const el = document.querySelector(selector);
//         if (el && el.innerText && el.innerText.trim()) {
//           return { element: el, selector: selector };
//         }
//       }
//       return { element: null, selector: null };
//     };

//     // –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∏—Å–ª–∞
//     const extractNumber = (text) => {
//       if (!text) return null;
//       const cleaned = text.replace(/\s+/g, '').replace(',', '.');
//       const match = cleaned.match(/[\d]+\.?[\d]*/);
//       return match ? parseFloat(match[0]) : null;
//     };

//     // === –¶–ï–ù–ê ===
//     const priceSelectors = [
//       '[data-testid="product-price"]',
//       '.Price_price__3rj7L',
//       'span[class*="Price_price"]:not([class*="old"])',
//       '.price',
//       '[itemprop="price"]'
//     ];

//     const priceResult = findElement(priceSelectors);
//     if (priceResult.element) {
//       result.price = extractNumber(priceResult.element.innerText);
//       result.debug.priceSelector = priceResult.selector;
//     }

//     // === –°–¢–ê–†–ê–Ø –¶–ï–ù–ê ===
//     const priceOldSelectors = [
//       '[data-testid="product-price-old"]',
//       '.Price_oldPrice__1mNRO',
//       'span[class*="Price_oldPrice"]',
//       '.old-price',
//       's',
//       'del'
//     ];

//     const priceOldResult = findElement(priceOldSelectors);
//     if (priceOldResult.element) {
//       const oldPrice = extractNumber(priceOldResult.element.innerText);
//       if (oldPrice && oldPrice > (result.price || 0)) {
//         result.priceOld = oldPrice;
//         result.debug.priceOldSelector = priceOldResult.selector;
//       }
//     }

//     // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –∑–∞—á–µ—Ä–∫–Ω—É—Ç–æ–π —Ü–µ–Ω—ã
//     if (!result.priceOld) {
//       const allElements = document.querySelectorAll('span, div');
//       for (const el of allElements) {
//         const style = window.getComputedStyle(el);
//         if (style.textDecoration.includes('line-through') && el.innerText.includes('‚ÇΩ')) {
//           const oldPrice = extractNumber(el.innerText);
//           if (oldPrice && oldPrice > (result.price || 0)) {
//             result.priceOld = oldPrice;
//             result.debug.priceOldSelector = 'line-through style';
//             break;
//           }
//         }
//       }
//     }

//     // === –†–ï–ô–¢–ò–ù–ì ===
//     const ratingSelectors = [
//       '[data-testid="product-rating"]',
//       '.Rating_rating__1KFrt',
//       'div[class*="Rating_rating"]',
//       '[itemprop="ratingValue"]',
//       '.rating'
//     ];

//     const ratingResult = findElement(ratingSelectors);
//     if (ratingResult.element) {
//       const rating = extractNumber(ratingResult.element.innerText);
//       if (rating !== null && rating >= 0 && rating <= 5) {
//         result.rating = rating;
//         result.debug.ratingSelector = ratingResult.selector;
//       }
//     }

//     // === –ö–û–õ–ò–ß–ï–°–¢–í–û –û–¢–ó–´–í–û–í ===
//     const reviewSelectors = [
//       '[data-testid="product-review-count"]',
//       '.Review_count__2nFJx',
//       'span[class*="Review_count"]',
//       '[itemprop="reviewCount"]',
//       'a[href*="review"]',
//       '.reviews'
//     ];

//     const reviewResult = findElement(reviewSelectors);
//     if (reviewResult.element) {
//       const count = extractNumber(reviewResult.element.innerText);
//       if (count !== null && count >= 0) {
//         result.reviewCount = count;
//         result.debug.reviewSelector = reviewResult.selector;
//       }
//     }

//     // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –æ—Ç–∑—ã–≤–æ–≤
//     if (result.reviewCount === null) {
//       const allElements = document.querySelectorAll('span, div, a, button');
//       for (const el of allElements) {
//         const text = el.innerText.toLowerCase();
//         if (text.includes('–æ—Ç–∑—ã–≤') || text.includes('–æ—Ü–µ–Ω–∫')) {
//           const count = extractNumber(el.innerText);
//           if (count !== null && count >= 0 && count < 1000000) {
//             result.reviewCount = count;
//             result.debug.reviewSelector = 'text search (–æ—Ç–∑—ã–≤)';
//             break;
//           }
//         }
//       }
//     }

//     return result;
//   });

//   // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
//   console.log('üìä Extraction results:');
  
//   if (htmlData.price !== null) {
//     console.log(`   ‚îú‚îÄ ‚úÖ Price: ${htmlData.price} ‚ÇΩ`);
//     console.log(`   ‚îÇ  ‚îî‚îÄ selector: ${htmlData.debug.priceSelector}`);
//   } else {
//     console.log(`   ‚îú‚îÄ ‚ùå Price: NOT FOUND`);
//   }

//   if (htmlData.priceOld !== null) {
//     console.log(`   ‚îú‚îÄ ‚úÖ Old price: ${htmlData.priceOld} ‚ÇΩ`);
//     console.log(`   ‚îÇ  ‚îî‚îÄ selector: ${htmlData.debug.priceOldSelector}`);
//   } else {
//     console.log(`   ‚îú‚îÄ ‚ö™ Old price: not found (no discount)`);
//   }

//   if (htmlData.rating !== null) {
//     console.log(`   ‚îú‚îÄ ‚úÖ Rating: ${htmlData.rating}`);
//     console.log(`   ‚îÇ  ‚îî‚îÄ selector: ${htmlData.debug.ratingSelector}`);
//   } else {
//     console.log(`   ‚îú‚îÄ ‚ùå Rating: NOT FOUND`);
//   }

//   if (htmlData.reviewCount !== null) {
//     console.log(`   ‚îî‚îÄ ‚úÖ Review count: ${htmlData.reviewCount}`);
//     console.log(`      ‚îî‚îÄ selector: ${htmlData.debug.reviewSelector}\n`);
//   } else {
//     console.log(`   ‚îî‚îÄ ‚ùå Review count: NOT FOUND\n`);
//   }

//   return htmlData;
// }

// // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
// (async () => {
//   console.log('üöÄ Starting parser...');
//   console.log(`üì¶ Product URL: ${productUrl}`);
//   console.log(`üåç Target region: ${targetRegion}\n`);

//   const browser = await puppeteer.launch({
//     headless: false,
//     args: [
//       '--no-sandbox',
//       '--disable-setuid-sandbox',
//       '--start-maximized',
//       '--disable-blink-features=AutomationControlled'
//     ],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   await page.setUserAgent(
//     'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
//   );
//   page.setDefaultTimeout(30000);

//   try {
//     // 1. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
//     console.log('üåê Loading product page...');
//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded\n');

//     // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Cloudflare
//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) {
//       throw new Error('Anti-bot check failed');
//     }

//     // 3. –ü—Ä–æ–±—É–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏–æ–Ω —á–µ—Ä–µ–∑ API
//     console.log('üîß Trying to apply region via API...');
//     const regionApplied = await page.evaluate((targetRegion) => {
//       if (!window.regionList) return false;
//       const region = window.regionList.find(r => r.name === targetRegion);
//       if (!region) return false;
//       try {
//         window.selectRegion(region.regionId);
//         return true;
//       } catch {
//         return false;
//       }
//     }, targetRegion);

//     if (regionApplied) {
//       console.log(`‚úÖ Region applied via API: "${targetRegion}"\n`);
//     } else {
//       console.warn('‚ö†Ô∏è  API method failed, using modal fallback...\n');
//       await applyRegionViaModal(page, targetRegion);
//     }

//     // 4. –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞
//     console.log('‚è≥ Waiting for page update after region change...');
//     await sleep(2000);
//     console.log('‚úì Ready to extract data\n');

//     // 5. –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ
//     const htmlData = await extractProductData(page);

//     // 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª product.txt
//     console.log('üíæ Saving data to product.txt...');

//     const outputLines = [];
//     if (htmlData.price !== null) outputLines.push(`price=${htmlData.price}`);
//     if (htmlData.priceOld !== null) outputLines.push(`priceOld=${htmlData.priceOld}`);
//     if (htmlData.rating !== null) outputLines.push(`rating=${htmlData.rating}`);
//     if (htmlData.reviewCount !== null) outputLines.push(`reviewCount=${htmlData.reviewCount}`);

//     if (outputLines.length > 0) {
//       const content = outputLines.join('\n');
//       fs.writeFileSync('product.txt', content);
//       console.log('‚úÖ Data saved to product.txt\n');
//       console.log('üìÑ File content:');
//       console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
//       console.log(content);
//       console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n');
//     } else {
//       console.warn('‚ö†Ô∏è  No data extracted!\n');
//       const html = await page.content();
//       fs.writeFileSync('debug.html', html);
//       console.log('üîç Saved debug.html for inspection\n');
//     }

//     // 7. –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç
//     console.log('üì∏ Taking screenshot...');
//     const dims = await page.evaluate(() => ({
//       w: document.documentElement.scrollWidth,
//       h: document.documentElement.scrollHeight
//     })).catch(() => ({ w: 0, h: 0 }));

//     if (dims.w > 0 && dims.h > 0) {
//       await page.screenshot({
//         path: 'screenshot.jpg',
//         fullPage: true,
//         type: 'jpeg',
//         quality: 90
//       });
//       console.log('‚úÖ Screenshot saved: screenshot.jpg\n');
//     }

//   } catch (err) {
//     console.error('\n‚ùå Parser failed:', err.message || err);
    
//     try {
//       const html = await page.content().catch(() => null);
//       if (html) {
//         fs.writeFileSync('error-page.html', html);
//         console.log('üîç Saved error-page.html for debugging\n');
//       }
//     } catch {}
    
//     throw err;
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed\n');
//   }
// })()
//   .then(() => {
//     console.log('‚úÖ Parser completed successfully!');
//     process.exit(0);
//   })
//   .catch((err) => {
//     console.error('üí• Critical error:', err.message);
//     process.exit(1);
//   });













// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(res => setTimeout(res, ms));

// const [, , productUrl, targetRegionRaw] = process.argv;
// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteerParser.js <PRODUCT_URL> <REGION>');
//   process.exit(1);
// }
// const targetRegion = targetRegionRaw.trim();

// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(()=>'');
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è Detected anti-bot / browser check page. Waiting for it to pass...');

//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(()=> '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed (page changed).');
//       return true;
//     }
//   }

//   console.error(`üí• Anti-bot check did not finish after ${timeoutSec}s`);
//   try { fs.writeFileSync('browser_check_page.html', html); } catch {}
//   return false;
// }

// // --- –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤—ã–±–æ—Ä–∞ —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ---
// async function applyRegionViaModal(page, targetRegion, { retries = 3 } = {}) {
//   const norm = s => (s || '').replace(/\s+/g,' ').trim().toLowerCase();
//   const normTarget = norm(targetRegion);

//   console.log(`üîÑ Applying region via modal: "${targetRegion}"`);

//   for (let attempt = 1; attempt <= retries; attempt++) {
//     console.log(`  ‚ñ∂ Attempt ${attempt}/${retries}`);

//     const regionButtonSelector = 'button[class^="Region_region__"]';
//     const btn = await page.$(regionButtonSelector).catch(()=>null);
//     if (!btn) {
//       console.warn('‚ö†Ô∏è Header region button not found');
//       await page.waitForTimeout(1200);
//       continue;
//     }

//     await btn.click({ delay: 100 });
//     await page.waitForTimeout(800); // –∞–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è

//     const modalRegionSelector = 'div[class^="UiRegionListBase_listWrapper__"] ul li button';
//     await page.waitForSelector(modalRegionSelector, { timeout: 3000 }).catch(()=>null);
//     const regionButtons = await page.$$(modalRegionSelector);

//     if (!regionButtons || !regionButtons.length) {
//       console.warn('‚ö†Ô∏è Modal with regions not found ‚Äî retrying...');
//       await page.waitForTimeout(1000);
//       continue;
//     }

//     console.log(`    Found ${regionButtons.length} regions in modal`);

//     let clicked = false;
//     for (const b of regionButtons) {
//       const text = await page.evaluate(el => el.innerText.trim(), b);
//       if (norm(text).includes(normTarget)) {
//         await b.click({ delay: 100 });
//         clicked = true;
//         console.log(`    ‚úÖ Clicked region: "${text}"`);
//         break;
//       }
//     }

//     if (!clicked) {
//       console.warn('‚ö†Ô∏è Target region not found in modal ‚Äî retrying...');
//       await page.waitForTimeout(1000);
//       continue;
//     }

//     await page.waitForTimeout(1500);
//     const headerText = await page.$eval(regionButtonSelector, el => el.innerText.trim()).catch(()=>null);
//     if (headerText && norm(headerText).includes(normTarget)) {
//       console.log(`    ‚úÖ Region verified in header: "${headerText}"`);
//       return true;
//     }

//     console.warn('    Region click did not verify ‚Äî retrying...');
//     await page.waitForTimeout(1000);
//   }

//   console.error('‚ö†Ô∏è Region not applied via modal after all attempts');
//   return false;
// }

// // --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ---
// (async () => {
//   const browser = await puppeteer.launch({
//     headless: false,
//     args: [
//       '--no-sandbox',
//       '--disable-setuid-sandbox',
//       '--start-maximized',
//       '--disable-blink-features=AutomationControlled'
//     ],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36');
//   page.setDefaultTimeout(30000);

//   try {
//     console.log('üöÄ Starting parser...');
//     console.log(`üì¶ Product URL: ${productUrl}`);
//     console.log(`üåç Target region: ${targetRegion}`);

//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded');

//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) throw new Error('Anti-bot check not passed');

//     // --- –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏–æ–Ω —á–µ—Ä–µ–∑ regionList API ---
//     const regionApplied = await page.evaluate((targetRegion) => {
//       if (!window.regionList) return false;
//       const r = window.regionList.find(r => r.name === targetRegion);
//       if (!r) return false;
//       try { window.selectRegion(r.regionId); return true; } catch { return false; }
//     }, targetRegion);

//     if (regionApplied) {
//       console.log(`‚úÖ Region applied via regionList API: "${targetRegion}"`);
//     } else {
//       console.warn('‚ö†Ô∏è regionList not found or region API failed, fallback to modal...');
//       await applyRegionViaModal(page, targetRegion);
//     }

//     await sleep(1200);

//     // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
//     const htmlData = await page.evaluate(() => {
//       const get = selectors => {
//         for (const s of selectors) {
//           const el = document.querySelector(s);
//           if (el && el.innerText && el.innerText.trim()) return el.innerText.trim();
//         }
//         return null;
//       };
//       const priceTxt = get(['[data-testid="product-price"]', '.Price_price', '.price', '[itemprop="price"]']);
//       const priceOldTxt = get(['[data-testid="product-price-old"]', '.Price_oldPrice', '.old-price', 's, del']);
//       const ratingTxt = get(['[data-testid="product-rating"]', '[itemprop="ratingValue"]', '.rating']);
//       const reviewsTxt = get(['[data-testid="product-review-count"]', '[itemprop="reviewCount"]', '.reviews']);

//       const num = t => {
//         if (!t) return null;
//         const cleaned = t.replace(/\s+/g,'').replace(',','.');
//         const m = cleaned.match(/[\d]+\.?[\d]*/);
//         return m ? parseFloat(m[0]) : null;
//       };

//       return {
//         price: num(priceTxt),
//         priceOld: num(priceOldTxt),
//         rating: num(ratingTxt),
//         reviewCount: num(reviewsTxt)
//       };
//     });

//     console.log('üìä HTML extraction results:', htmlData);

//     const out = [];
//     for (const [k,v] of Object.entries(htmlData)) if (v != null) out.push(`${k}=${v}`);
//     fs.writeFileSync('product.txt', out.join('\n'));
//     console.log('üíæ Data saved to product.txt');

//     const dims = await page.evaluate(() => ({ w: document.documentElement.scrollWidth, h: document.documentElement.scrollHeight })).catch(()=>({w:0,h:0}));
//     if (dims.w > 0 && dims.h > 0) {
//       await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
//       console.log('üì∏ Screenshot saved: screenshot.jpg');
//     }

//   } catch (err) {
//     console.error('üí• Parser failed:', err.message || err);
//     try {
//       const html = await page.content().catch(()=>null);
//       if (html) fs.writeFileSync('error_page.html', html);
//       console.log('üß© Saved error_page.html for debugging');
//     } catch {}
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed');
//   }
// })();










// // puppeteerParser.js
// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(res => setTimeout(res, ms));

// const [, , productUrl, targetRegionRaw] = process.argv;
// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteerParser.js <PRODUCT_URL> <REGION>');
//   process.exit(1);
// }
// const targetRegion = targetRegionRaw.trim();

// // --- –û–∂–∏–¥–∞–Ω–∏–µ Cloudflare/–∞–Ω—Ç–∏–±–æ—Ç–∞ ---
// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(()=>'');
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è Detected anti-bot / browser check page. Waiting...');
//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(()=> '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed');
//       return true;
//     }
//   }
//   console.error(`üí• Anti-bot check did not finish after ${timeoutSec}s`);
//   try { fs.writeFileSync('browser_check_page.html', html); } catch {}
//   return false;
// }

// // --- –ù–æ–≤—ã–π applyRegion —Å —Ä–∞–∑–±–æ—Ä–æ–º —Ç–µ–∫—Å—Ç–∞ –º–æ–¥–∞–ª–∫–∏ ---
// async function applyRegion(page, targetRegion, { retries = 3 } = {}) {
//   const norm = s => (s || '').replace(/\s+/g,' ').trim().toLowerCase();
//   const normTarget = norm(targetRegion);
//   console.log(`üîÑ Applying region via modal: "${targetRegion}"`);

//   for (let attempt = 1; attempt <= retries; attempt++) {
//     console.log(`  ‚ñ∂ Attempt ${attempt}/${retries}`);

//     // 1) –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞ –≤ —à–∞–ø–∫–µ
//     const headerSelectors = [
//       '[data-testid="region-header-link"]',
//       '.header__region',
//       '.header [class*="region"]',
//       'button[class*="region"]',
//       'a[class*="region"]'
//     ];
//     let headerHandle = null;
//     for (const sel of headerSelectors) {
//       try { headerHandle = await page.$(sel); } catch {}
//       if (headerHandle) break;
//     }
//     if (!headerHandle) {
//       console.warn('‚ö†Ô∏è Header region button not found');
//       await sleep(1200);
//       continue;
//     }

//     const headerText = await page.evaluate(el => el.innerText?.trim(), headerHandle).catch(()=> '');
//     console.log(`    Header candidate found: "${headerText}"`);

//     try {
//       await headerHandle.evaluate(el => el.scrollIntoView({ block: 'center' }));
//       await headerHandle.click({ delay: 100 });
//     } catch { try { await page.evaluate(el => el.click(), headerHandle); } catch {} }
//     await sleep(1000);

//     // 2) –ñ–¥—ë–º –º–æ–¥–∞–ª–∫—É
//     const modalSelectors = ['div[role="dialog"]', '.region-list', 'ul[class*="regions"]'];
//     let modalHandle = null;
//     for (const ms of modalSelectors) {
//       try { modalHandle = await page.$(ms); } catch {}
//       if (modalHandle) break;
//     }
//     if (!modalHandle) {
//       console.warn('    Modal with regions not found ‚Äî retrying...');
//       await sleep(1200);
//       continue;
//     }
//     console.log('    ‚úì Modal appeared');

//     // 3) –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –º–æ–¥–∞–ª–∫–∏ –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
//     const modalText = await page.evaluate(modal => modal.innerText, modalHandle);
//     const lines = modalText.split('\n').map(l => l.trim()).filter(Boolean);
//     console.log('    Modal lines:', lines);

//     // 4) –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π —Ä–µ–≥–∏–æ–Ω
//     const matchLine = lines.find(l => norm(l).includes(normTarget));
//     if (!matchLine) {
//       console.warn(`    ‚ö†Ô∏è Target region "${targetRegion}" not found in modal lines`);
//       await sleep(1200);
//       continue;
//     }
//     console.log(`    ‚úÖ Match line: "${matchLine}"`);

//     // 5) –ù–∞—Ö–æ–¥–∏–º DOM —ç–ª–µ–º–µ–Ω—Ç –∏ –∫–ª–∏–∫–∞–µ–º
//     const escaped = matchLine.replace(/"/g, '\\"');
//     const xpath = `//*[contains(normalize-space(string(.)), "${escaped}")]`;
//     const handles = await page.$x(xpath).catch(()=>[]);
//     if (!handles.length) {
//       console.warn('    ‚ö†Ô∏è Could not find DOM element for matched region ‚Äî retrying');
//       await sleep(1000);
//       continue;
//     }

//     let clicked = false;
//     for (const h of handles) {
//       try { await h.evaluate(el => el.scrollIntoView({ block: 'center' })); await h.click({ delay: 80 }); clicked = true; break; } catch {}
//     }
//     if (!clicked) { console.warn('    ‚ö†Ô∏è Click failed ‚Äî retrying'); await sleep(1000); continue; }

//     // 6) –ñ–¥—ë–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –∫—É–∫–∏
//     await sleep(1800);
//     const newHeader = await page.evaluate(() => {
//       const s = document.querySelector('[data-testid="region-header-link"], .header__region, .header [class*="region"], [class*="region"]');
//       return s ? s.innerText.trim() : null;
//     }).catch(()=>null);

//     const cookies = await page.cookies().catch(()=>[]);
//     const regionCookie = cookies.find(c => /region/i.test(c.name) || /region/i.test(c.value));

//     if ((newHeader && norm(newHeader).includes(normTarget)) ||
//         (regionCookie && norm(regionCookie.value).includes(normTarget.split(' ')[0]))) {
//       console.log(`    ‚úÖ Region successfully applied: "${targetRegion}"`);
//       return true;
//     }

//     console.warn('    ‚ö†Ô∏è Region click did not verify ‚Äî retrying...');
//     await sleep(1000);
//   }
//   return false;
// }

// // --- –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä ---
// (async () => {
//   const browser = await puppeteer.launch({
//     headless: false,
//     args: ['--no-sandbox','--disable-setuid-sandbox','--start-maximized','--disable-blink-features=AutomationControlled'],
//     defaultViewport: null
//   });
//   const page = await browser.newPage();
//   await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36');
//   page.setDefaultTimeout(30000);

//   try {
//     console.log('üöÄ Starting parser...');
//     console.log(`üì¶ Product URL: ${productUrl}`);
//     console.log(`üåç Target region: ${targetRegion}`);

//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded');

//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) throw new Error('Anti-bot check not passed');

//     const ok = await applyRegion(page, targetRegion, { retries: 3 });
//     if (!ok) console.warn('‚ö†Ô∏è Region not verified - continuing with default region');

//     await sleep(1200);

//     // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
//     const htmlData = await page.evaluate(() => {
//       const get = selectors => {
//         for (const s of selectors) {
//           const el = document.querySelector(s);
//           if (el && el.innerText && el.innerText.trim()) return el.innerText.trim();
//         }
//         return null;
//       };
//       const priceTxt = get(['[data-testid="product-price"]', '.Price_price', '.price', '[itemprop="price"]']);
//       const priceOldTxt = get(['[data-testid="product-price-old"]', '.Price_oldPrice', '.old-price', 's, del']);
//       const ratingTxt = get(['[data-testid="product-rating"]', '[itemprop="ratingValue"]', '.rating']);
//       const reviewsTxt = get(['[data-testid="product-review-count"]', '[itemprop="reviewCount"]', '.reviews']);

//       const num = t => {
//         if (!t) return null;
//         const cleaned = t.replace(/\s+/g,'').replace(',','.');
//         const m = cleaned.match(/[\d]+\.?[\d]*/);
//         return m ? parseFloat(m[0]) : null;
//       };

//       return {
//         price: num(priceTxt),
//         priceOld: num(priceOldTxt),
//         rating: num(ratingTxt),
//         reviewCount: num(reviewsTxt)
//       };
//     });

//     console.log('üìä HTML extraction results:', htmlData);

//     const out = [];
//     for (const [k,v] of Object.entries(htmlData)) if (v != null) out.push(`${k}=${v}`);
//     fs.writeFileSync('product.txt', out.join('\n'));
//     console.log('üíæ Data saved to product.txt');

//     // --- –°–∫—Ä–∏–Ω—à–æ—Ç ---
//     const dims = await page.evaluate(() => ({ w: document.documentElement.scrollWidth, h: document.documentElement.scrollHeight })).catch(()=>({w:0,h:0}));
//     if (dims.w > 0 && dims.h > 0) {
//       await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
//       console.log('üì∏ Screenshot saved: screenshot.jpg');
//     } else console.warn('‚ö†Ô∏è Page dimensions 0 ‚Äî skipping screenshot');

//   } catch (err) {
//     console.error('üí• Parser failed:', err.message || err);
//     try {
//       const html = await page.content().catch(()=>null);
//       if (html) fs.writeFileSync('error_page.html', html);
//       console.log('üß© Saved error_page.html for debugging');
//     } catch {}
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed');
//   }
// })();





// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(res => setTimeout(res, ms));

// const [, , productUrl, targetRegionRaw] = process.argv;
// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteerParser.js <PRODUCT_URL> <REGION>');
//   process.exit(1);
// }
// const targetRegion = targetRegionRaw.trim();

// // --- –û–∂–∏–¥–∞–Ω–∏–µ Cloudflare/anti-bot ---
// async function waitForCloudflare(page, timeoutSec = 20) {
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(()=>'');
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è Detected anti-bot / browser check page. Waiting...');
//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(()=> '');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed');
//       return true;
//     }
//   }
//   console.error(`üí• Anti-bot check did not finish after ${timeoutSec}s`);
//   fs.writeFileSync('browser_check_page.html', html);
//   return false;
// }

// // --- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ —Å –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–æ–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∫–ª–∏–∫–æ–º ---
// async function applyRegion(page, targetRegion, { retries = 3 } = {}) {
//   const norm = s => (s || '').replace(/\s+/g,' ').trim().toLowerCase();
//   const normTarget = norm(targetRegion);
//   console.log(`üîÑ Applying region: "${targetRegion}"`);

//   for (let attempt = 1; attempt <= retries; attempt++) {
//     console.log(`  ‚ñ∂ attempt ${attempt}/${retries}`);

//     // 1) –∏—â–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞
//     const headerSelectors = [
//       '[data-testid="region-header-link"]',
//       '[data-testid*="region"]',
//       'button[class*="region"]',
//       'a[class*="region"]',
//       '.header [class*="region"]',
//       '.header__region',
//     ];

//     let headerHandle = null;
//     for (const sel of headerSelectors) {
//       headerHandle = await page.$(sel).catch(()=>null);
//       if (headerHandle) break;
//     }

//     if (headerHandle) {
//       const text = await page.evaluate(el => el.innerText?.trim() || '', headerHandle).catch(()=> '');
//       console.log(`    header candidate found: "${text?.slice(0,120)}"`);

//       // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø–µ—Ä–µ–¥ –∫–ª–∏–∫–æ–º
//       await headerHandle.evaluate(el => el.scrollIntoView({behavior:'smooth', block:'center'}));
//       await sleep(800);
//       try { await headerHandle.click({delay:100}); } catch { 
//         await page.evaluate(el=>el.click(), headerHandle).catch(()=>{}); 
//       }
//       await sleep(900);
//     }

//     // 2) —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
//     const candidates = await page.evaluate(() => {
//       const els = Array.from(document.querySelectorAll('button, a, [role="button"], span, div'));
//       return els.filter(e => {
//         const txt = e.innerText?.trim();
//         const style = window.getComputedStyle(e);
//         return txt && txt.length < 250 && style && style.display !== 'none' && style.visibility !== 'hidden' && parseFloat(style.opacity)!==0;
//       }).map(e=>e.innerText.trim());
//     }).catch(()=>[]);

//     if(!candidates.length){
//       console.log('    no clickable candidates found, retrying...');
//       await sleep(1200);
//       continue;
//     }

//     // 3) –∏—â–µ–º –ª—É—á—à–∏–π —Å–æ–≤–ø–∞–¥–∞—é—â–∏–π —Ä–µ–≥–∏–æ–Ω
//     let bestMatch = candidates.find(c=>norm(c) === normTarget || norm(c).includes(normTarget));
//     if(!bestMatch) {
//       const token = normTarget.split(' ')[0];
//       bestMatch = candidates.find(c=>norm(c).includes(token));
//     }
//     if(!bestMatch){
//       console.log('    no matching candidate found this attempt');
//       await sleep(1200);
//       continue;
//     }
//     console.log(`    best match: "${bestMatch}" ‚Äî attempting to click`);

//     // 4) –∫–ª–∏–∫–∞–µ–º —á–µ—Ä–µ–∑ page.evaluate (–±–µ–∑ $x)
//     const clicked = await page.evaluate((text)=>{
//       const el = Array.from(document.querySelectorAll('button, a, [role="button"], span, div'))
//         .find(e=>e.innerText?.trim() === text);
//       if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.click(); return true; }
//       return false;
//     }, bestMatch);

//     if(!clicked){
//       console.warn('    click failed ‚Äî retrying attempt');
//       await sleep(900);
//       continue;
//     }

//     // 5) –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏–ª–∏ cookie
//     await sleep(1800);
//     const headerText = await page.evaluate(()=>{
//       const s = document.querySelector('[data-testid="region-header-link"], .header__region, .header [class*="region"], [class*="region"]');
//       return s ? s.innerText.trim() : null;
//     }).catch(()=>null);

//     if(headerText && norm(headerText).includes(normTarget)) return true;

//     const cookies = await page.cookies().catch(()=>[]);
//     const rc = cookies.find(c=>/region/i.test(c.name) || /region/i.test(c.value));
//     if(rc && norm(rc.value).includes(normTarget.split(' ')[0])) return true;

//     console.warn('    region click did not verify ‚Äî retrying');
//     await sleep(900);
//   }

//   return false;
// }

// // --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ ---
// (async () => {
//   const browser = await puppeteer.launch({
//     headless: false,
//     args: ['--no-sandbox','--disable-setuid-sandbox','--start-maximized','--disable-blink-features=AutomationControlled'],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36');
//   page.setDefaultTimeout(30000);

//   try {
//     console.log('üöÄ Starting parser...');
//     console.log(`üì¶ Product URL: ${productUrl}`);
//     console.log(`üåç Target region: ${targetRegion}`);

//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded');

//     const cfPassed = await waitForCloudflare(page, 25);
//     if(!cfPassed) throw new Error('Anti-bot check not passed');

//     const ok = await applyRegion(page, targetRegion, { retries: 3 });
//     if(!ok) console.warn('‚ö†Ô∏è Region not verified ‚Äî proceeding with default region');

//     await sleep(1200);

//     // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
//     const htmlData = await page.evaluate(() => {
//       const get = selectors => selectors.map(s=>document.querySelector(s)?.innerText?.trim()).find(Boolean);
//       const priceTxt = get(['[data-testid="product-price"]', '.Price_price', '.price', '[itemprop="price"]']);
//       const priceOldTxt = get(['[data-testid="product-price-old"]', '.Price_oldPrice', '.old-price', 's, del']);
//       const ratingTxt = get(['[data-testid="product-rating"]', '[itemprop="ratingValue"]', '.rating']);
//       const reviewsTxt = get(['[data-testid="product-review-count"]', '[itemprop="reviewCount"]', '.reviews']);

//       const num = t => t ? parseFloat(t.replace(/\s+/g,'').replace(',','.').match(/[\d]+\.?[\d]*/)?.[0]||null) : null;

//       return { price:num(priceTxt), priceOld:num(priceOldTxt), rating:num(ratingTxt), reviewCount:num(reviewsTxt) };
//     });

//     console.log('üìä HTML extraction results:', htmlData);

//     const out = Object.entries(htmlData).filter(([_,v])=>v!=null).map(([k,v])=>`${k}=${v}`);
//     fs.writeFileSync('product.txt', out.join('\n'));
//     console.log('üíæ Data saved to product.txt');

//     const dims = await page.evaluate(()=>({w:document.documentElement.scrollWidth, h:document.documentElement.scrollHeight})).catch(()=>({w:0,h:0}));
//     if(dims.w>0 && dims.h>0){ 
//       await page.screenshot({ path: 'screenshot.jpg', fullPage:true }); 
//       console.log('üì∏ Screenshot saved'); 
//     }

//   } catch(err){
//     console.error('üí• Parser failed:', err.message||err);
//     const html = await page.content().catch(()=>null);
//     if(html) fs.writeFileSync('error_page.html', html);
//     console.log('üß© Saved error_page.html');
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed');
//   }
// })();













// // puppeteerParser.js
// import puppeteer from 'puppeteer-extra';
// import StealthPlugin from 'puppeteer-extra-plugin-stealth';
// import fs from 'fs';

// puppeteer.use(StealthPlugin());

// const sleep = ms => new Promise(res => setTimeout(res, ms));

// const [, , productUrl, targetRegionRaw] = process.argv;
// if (!productUrl || !targetRegionRaw) {
//   console.error('Usage: node puppeteerParser.js <PRODUCT_URL> <REGION>');
//   process.exit(1);
// }
// const targetRegion = targetRegionRaw.trim();

// async function waitForCloudflare(page, timeoutSec = 20) {
//   // –ï—Å–ª–∏ –≤–∏–¥–∏–º —Ç–µ–∫—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ ‚Äî –∂–¥—ë–º —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ / –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
//   const checkPattern = /–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è\s+–ø—Ä–æ–≤–µ—Ä–∫–∞|checking\s+your\s+browser|–ü–æ–¥–æ–∂–¥–∏—Ç–µ|Please\s+stand\s+by/i;
//   let html = await page.content().catch(()=>'');
//   if (!checkPattern.test(html)) return true;

//   console.warn('‚ö†Ô∏è Detected anti-bot / browser check page. Waiting for it to pass...');

//   const start = Date.now();
//   while ((Date.now() - start) < timeoutSec * 1000) {
//     await sleep(1000);
//     html = await page.content().catch(()=>'');
//     if (!checkPattern.test(html)) {
//       console.log('‚úÖ Anti-bot check passed (page changed).');
//       return true;
//     }
//   }

//   console.error(`üí• Anti-bot check did not finish after ${timeoutSec}s`);
//   // save snapshot for debugging
//   try { fs.writeFileSync('browser_check_page.html', html); } catch {}
//   return false;
// }

// async function applyRegion(page, targetRegion, { retries = 3 } = {}) {
//   const norm = s => (s || '').replace(/\s+/g,' ').trim().toLowerCase();
//   const normTarget = norm(targetRegion);
//   console.log(`üîÑ Applying region: "${targetRegion}"`);

//   for (let attempt = 1; attempt <= retries; attempt++) {
//     console.log(`  ‚ñ∂ attempt ${attempt}/${retries}`);

//     // 1) Try obvious header selectors
//     const headerSelectors = [
//       '[data-testid="region-header-link"]',
//       '[data-testid*="region"]',
//       'button[class*="region"]',
//       'a[class*="region"]',
//       '.header [class*="region"]',
//       '.header__region',
//     ];

//     let headerHandle = null;
//     for (const sel of headerSelectors) {
//       try {
//         headerHandle = await page.$(sel);
//       } catch {}
//       if (headerHandle) break;
//     }

//     if (headerHandle) {
//       const text = await page.evaluate(el => el.innerText?.trim() || el.textContent || '', headerHandle).catch(()=> '');
//       console.log(`    header candidate found: "${(text||'').slice(0,120)}"`);
//       try {
//         await headerHandle.evaluate(el => el.scrollIntoView({block:'center'}));
//         await headerHandle.click({ delay: 100 });
//       } catch {
//         try { await page.evaluate(el => el.click(), headerHandle); } catch {}
//       }
//       await sleep(900);
//     } else {
//       console.log('    header region button not found by common selectors.');
//     }

//     // 2) Wait for modal OR scan clickable elements
//     const modalSelectors = [
//       'div[role="dialog"]',
//       'div[class*="region-list"]',
//       'ul[class*="regions"]',
//       '.region-list'
//     ];

//     let candidates = [];

//     // if modal appears, gather its items
//     for (const ms of modalSelectors) {
//       const modal = await page.$(ms).catch(()=>null);
//       if (modal) {
//         // gather items inside modal
//         candidates = await page.$$eval(
//           `${ms} li, ${ms} button, ${ms} a, ${ms} [role="button"]`,
//           nodes => nodes.map(n => n.innerText?.replace(/\s+/g,' ').trim()).filter(Boolean)
//         ).catch(()=>[]);
//         if (candidates.length) {
//           console.log(`    modal "${ms}" yielded ${candidates.length} items (showing first 20)`);
//           candidates.slice(0,20).forEach((c,i)=> console.log(`      ${i+1}. ${c}`));
//           break;
//         }
//       }
//     }

//     // if no modal items ‚Äî fallback: scan visible clickable elements (limit)
//     if (!candidates.length) {
//       console.log('    modal not found ‚Äî scanning clickable elements fallback (buttons/links/spans)...');
//       candidates = await page.$$eval(
//         'button, a, [role="button"], span, div',
//         (els) => {
//           const out = [];
//           for (let i=0; i<els.length && out.length < 400; i++) {
//             const e = els[i];
//             const txt = e.innerText?.replace(/\s+/g,' ').trim();
//             if (!txt || txt.length > 250) continue;
//             const style = window.getComputedStyle(e);
//             if (!style || style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity) === 0) continue;
//             out.push(txt);
//           }
//           return out;
//         }
//       ).catch(()=>[]);
//       console.log(`    scanned ${candidates.length} clickable elements (showing first 30)`);
//       candidates.slice(0,30).forEach((c,i)=> console.log(`      ${i+1}. ${c}`));
//     }

//     // 3) find best match
//     let bestIdx = -1;
//     for (let i=0;i<candidates.length;i++){
//       const t = norm(candidates[i] || '');
//       if (!t) continue;
//       if (t === normTarget) { bestIdx = i; break; }
//       if (t.includes(normTarget)) { bestIdx = i; break; }
//     }
//     if (bestIdx === -1) {
//       // try partial word match
//       const token = normTarget.split(' ')[0];
//       for (let i=0;i<candidates.length;i++){
//         if (norm(candidates[i]||'').includes(token)) { bestIdx = i; break; }
//       }
//     }

//     if (bestIdx === -1) {
//       console.log('    no matching candidate found this attempt');
//       await sleep(1200);
//       continue;
//     }

//     const matchText = candidates[bestIdx];
//     console.log(`    best match: "${matchText}" ‚Äî attempting to click it`);

//     // 4) click element by XPath matching text snippet (best-effort)
//     const escaped = matchText.replace(/"/g, '\\"');
//     const xpath = `//*[contains(normalize-space(string(.)), "${escaped}")]`;
//     const handles = await page.$x(xpath).catch(()=>[]);
//     let clicked = false;
//     if (handles && handles.length) {
//       for (const h of handles) {
//         const txt = await page.evaluate(el => el.innerText?.replace(/\s+/g,' ').trim(), h).catch(()=>'');
//         if (!txt) continue;
//         if (txt.slice(0,200) === matchText || txt.includes(matchText) || matchText.includes(txt)) {
//           try {
//             await h.evaluate(el=>el.scrollIntoView({block:'center'})).catch(()=>{});
//             await h.click({ delay: 80 }).catch(async ()=>{ await page.evaluate(el=>el.click(), h).catch(()=>{}); });
//             clicked = true;
//             break;
//           } catch (e) { /* try next handle */ }
//         }
//       }
//     }

//     if (!clicked) {
//       console.warn('    clicking candidate failed ‚Äî retrying attempt');
//       await sleep(900);
//       continue;
//     }

//     // 5) wait and verify
//     await sleep(1800);
//     // verify by header text
//     const headerText = await page.evaluate(() => {
//       const s = document.querySelector('[data-testid="region-header-link"], .header__region, .header [class*="region"], [class*="region"]');
//       return s ? s.innerText.trim() : null;
//     }).catch(()=>null);

//     if (headerText && norm(headerText).includes(normTarget)) {
//       console.log(`    ‚úÖ Verified region by header: "${headerText}"`);
//       return true;
//     }

//     // verify by cookies
//     const cookies = await page.cookies().catch(()=>[]);
//     const rc = cookies.find(c => /region/i.test(c.name) || /region/i.test(c.value));
//     if (rc) {
//       console.log(`    üç™ Region cookie: ${rc.name}=${rc.value}`);
//       if (norm(rc.value).includes(normTarget.split(' ')[0])) return true;
//     }

//     // not verified: try again
//     console.warn('    region click did not verify ‚Äî will retry if attempts left');
//     await sleep(900);
//   } // attempts

//   return false;
// }

// (async () => {
//   // Launch with stealth-friendly args
//   const browser = await puppeteer.launch({
//     headless: false,
//     args: [
//       '--no-sandbox',
//       '--disable-setuid-sandbox',
//       '--start-maximized',
//       '--disable-blink-features=AutomationControlled'
//     ],
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   // set a realistic user-agent
//   await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36');
//   page.setDefaultTimeout(30000);

//   try {
//     console.log('üöÄ Starting parser...');
//     console.log(`üì¶ Product URL: ${productUrl}`);
//     console.log(`üåç Target region: ${targetRegion}`);

//     await page.goto(productUrl, { waitUntil: 'domcontentloaded' });
//     console.log('‚úì Page loaded');

//     // Wait and handle Cloudflare/anti-bot check
//     const cfPassed = await waitForCloudflare(page, 25);
//     if (!cfPassed) {
//       throw new Error('Anti-bot check not passed');
//     }

//     // Apply region
//     const ok = await applyRegion(page, targetRegion, { retries: 3 });
//     if (!ok) console.warn('‚ö†Ô∏è Region not verified - continuing but results may be from default region');

//     await sleep(1200);

//     // Extract data (fallback selectors)
//     const htmlData = await page.evaluate(() => {
//       const get = selectors => {
//         for (const s of selectors) {
//           const el = document.querySelector(s);
//           if (el && el.innerText && el.innerText.trim()) return el.innerText.trim();
//         }
//         return null;
//       };
//       const priceTxt = get(['[data-testid="product-price"]', '.Price_price', '.price', '[itemprop="price"]']);
//       const priceOldTxt = get(['[data-testid="product-price-old"]', '.Price_oldPrice', '.old-price', 's, del']);
//       const ratingTxt = get(['[data-testid="product-rating"]', '[itemprop="ratingValue"]', '.rating']);
//       const reviewsTxt = get(['[data-testid="product-review-count"]', '[itemprop="reviewCount"]', '.reviews']);

//       const num = t => {
//         if (!t) return null;
//         const cleaned = t.replace(/\s+/g,'').replace(',','.');
//         const m = cleaned.match(/[\d]+\.?[\d]*/);
//         return m ? parseFloat(m[0]) : null;
//       };

//       return {
//         price: num(priceTxt),
//         priceOld: num(priceOldTxt),
//         rating: num(ratingTxt),
//         reviewCount: num(reviewsTxt)
//       };
//     });

//     console.log('üìä HTML extraction results:', htmlData);

//     // Save product.txt (simple key=value lines)
//     const out = [];
//     for (const [k,v] of Object.entries(htmlData)) if (v != null) out.push(`${k}=${v}`);
//     fs.writeFileSync('product.txt', out.join('\n'));
//     console.log('üíæ Data saved to product.txt');

//     // Safe screenshot
//     const dims = await page.evaluate(() => ({ w: document.documentElement.scrollWidth, h: document.documentElement.scrollHeight })).catch(()=>({w:0,h:0}));
//     if (dims.w > 0 && dims.h > 0) {
//       await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
//       console.log('üì∏ Screenshot saved: screenshot.jpg');
//     } else {
//       console.warn('‚ö†Ô∏è Page dimensions 0 ‚Äî skipping screenshot');
//     }

//   } catch (err) {
//     console.error('üí• Parser failed:', err.message || err);
//     try {
//       const html = await page.content().catch(()=>null);
//       if (html) fs.writeFileSync('error_page.html', html);
//       console.log('üß© Saved error_page.html for debugging');
//     } catch {}
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed');
//   }
// })();







// import puppeteer from "puppeteer";
// import fs from "fs";

// const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// const [, , productUrl, targetRegion] = process.argv;

// if (!productUrl || !targetRegion) {
//   console.error("Usage: node puppeteer.js <productUrl> <regionName>");
//   process.exit(1);
// }

// async function parseProduct(url, regionName) {
//   console.log(`üöÄ Starting parser...\nüì¶ Product URL: ${url}\nüåç Target region: ${regionName}\n`);

//   const browser = await puppeteer.launch({ headless: false, args: ['--start-maximized'] });
//   const page = await browser.newPage();
//   await page.setViewport({ width: 1920, height: 1080 });
//   page.setDefaultTimeout(30000);

//   try {
//     console.log("üåê Navigating to product page...");
//     await page.goto(url, { waitUntil: "networkidle2" });
//     console.log("‚úì Page loaded\n");

//     // --- –ú–µ–Ω—è–µ–º —Ä–µ–≥–∏–æ–Ω —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ---
//     console.log(`üîÑ Changing region to "${regionName}"...`);

//     try {
//       const regionButtonSelector = '[data-testid="region-header-link"], button[class*="Region"]';
//       await page.waitForSelector(regionButtonSelector, { timeout: 5000 });
//       const regionButton = await page.$(regionButtonSelector);
//       await regionButton.click();
//       await sleep(2000);

//       const modalSelector = 'div[role="dialog"] ul, div[class*="region-list"]';
//       await page.waitForSelector(modalSelector, { timeout: 5000 });

//       const regionApplied = await page.evaluate((regionName) => {
//         const items = document.querySelectorAll('div[role="dialog"] li, div[class*="region-list"] li');
//         for (const item of items) {
//           if (item.textContent.includes(regionName)) {
//             item.click();
//             return true;
//           }
//         }
//         return false;
//       }, regionName);

//       if (!regionApplied) {
//         console.warn(`‚ö†Ô∏è Region "${regionName}" not found in modal list`);
//       } else {
//         console.log(`‚úÖ Region "${regionName}" selected, waiting for page reload...`);
//         await page.waitForNavigation({ waitUntil: "networkidle2" });
//         await sleep(2000);
//       }
//     } catch (err) {
//       console.warn(`‚ö†Ô∏è Failed to change region: ${err.message}`);
//     }

//     // --- –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ HTML ---
//     console.log("üìÑ Extracting data from HTML DOM...");
//     const data = await page.evaluate(() => {
//       const extractNumber = (text) => {
//         if (!text) return null;
//         const cleaned = text.replace(/\s+/g, '').replace(',', '.');
//         const match = cleaned.match(/[\d]+\.?[\d]*/);
//         return match ? parseFloat(match[0]) : null;
//       };

//       const priceEl = document.querySelector('[class*="Price_price"]:not([class*="old"]), [data-testid*="price"], [itemprop="price"]');
//       const oldPriceEl = document.querySelector('[class*="Price_oldPrice"], [class*="oldPrice"], s, del');

//       const ratingEl = document.querySelector('[class*="Rating"], [itemprop="ratingValue"], [data-testid*="rating"]');
//       const reviewEl = document.querySelector('[class*="Review"], [itemprop="reviewCount"], a[href*="review"]');

//       return {
//         price: extractNumber(priceEl?.textContent),
//         priceOld: extractNumber(oldPriceEl?.textContent),
//         rating: extractNumber(ratingEl?.textContent),
//         reviewCount: extractNumber(reviewEl?.textContent)
//       };
//     });

//     console.log(`üìä Extracted data: ${JSON.stringify(data)}`);

//     // --- –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª ---
//     let content = "";
//     if (data.price !== null) content += `price=${data.price}\n`;
//     if (data.priceOld !== null) content += `priceOld=${data.priceOld}\n`;
//     if (data.rating !== null) content += `rating=${data.rating}\n`;
//     if (data.reviewCount !== null) content += `reviewCount=${data.reviewCount}\n`;

//     if (content) {
//       fs.writeFileSync('product.txt', content.trim());
//       console.log("üíæ Data saved to product.txt");
//     } else {
//       console.warn("‚ö†Ô∏è No data extracted, check the page manually.");
//     }

//     // --- –°–∫—Ä–∏–Ω—à–æ—Ç ---
//     await page.screenshot({ path: "screenshot.jpg", fullPage: true });
//     console.log("üì∏ Screenshot saved: screenshot.jpg");

//   } catch (err) {
//     console.error("‚ùå Parser failed:", err);
//   } finally {
//     await browser.close();
//     console.log("üîí Browser closed");
//   }
// }

// parseProduct(productUrl, targetRegion);












// const applyRegion = async (page, targetRegion) => {
//   console.log(`üîÑ Changing region to "${targetRegion}"...`);

//   // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–∏–æ–Ω
//   const currentRegion = await page.evaluate(() => {
//     const el = document.querySelector('[class*="Region"] [class*="text"], [class*="region"] span');
//     return el?.textContent?.trim() || null;
//   });

//   if (currentRegion?.toLowerCase() === targetRegion.toLowerCase()) {
//     console.log(`‚úÖ Region already set: "${currentRegion}"`);
//     return true;
//   }

//   // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏–æ–Ω–∞
//   let regionButton;
//   try {
//     regionButton = await page.waitForSelector(
//       'button:has([class*="Region"]), [class*="region"], [data-testid*="region"]',
//       { visible: true, timeout: 7000 }
//     );
//   } catch {
//     console.warn('‚ö†Ô∏è Region button not found on page');
//     return false;
//   }

//   console.log('‚úì Region button found, clicking...');
//   await page.evaluate(el => el.scrollIntoView({ behavior: "smooth", block: "center" }), regionButton);
//   try {
//     await regionButton.click();
//   } catch {
//     await page.evaluate(el => el.click(), regionButton);
//   }

//   await sleep(1500);

//   // –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª–∫–∏
//   await page.waitForSelector(
//     'div[role="dialog"], [class*="Modal"], [class*="region-list"], [class*="region"] ul',
//     { visible: true, timeout: 8000 }
//   ).catch(() => console.warn('‚ö†Ô∏è Region modal did not appear'));

//   // –ò—â–µ–º —Ä–µ–≥–∏–æ–Ω –≤ –º–æ–¥–∞–ª–∫–µ
//   const regionApplied = await page.evaluate((target) => {
//     const selectors = [
//       'div[role="dialog"] li',
//       'div[role="dialog"] button',
//       '[class*="region-list"] li',
//       '[class*="region"] li',
//       '[class*="region"] button',
//       'ul li',
//       'ul button'
//     ];

//     let found = false;
//     for (const sel of selectors) {
//       const items = document.querySelectorAll(sel);
//       for (const item of items) {
//         const text = item.textContent?.trim();
//         if (!text) continue;
//         if (text.toLowerCase().includes(target.toLowerCase())) {
//           item.scrollIntoView({ behavior: "smooth", block: "center" });
//           item.click();
//           found = true;
//           break;
//         }
//       }
//       if (found) break;
//     }
//     return found;
//   }, targetRegion);

//   if (!regionApplied) {
//     console.warn(`‚ö†Ô∏è Region "${targetRegion}" not found in modal list`);
//     return false;
//   }

//   console.log(`üïí Waiting for page to update region...`);
//   await page.waitForNavigation({ waitUntil: "networkidle2" }).catch(() => {});
//   await sleep(2500);

//   // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–≥–∏–æ–Ω —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è
//   const appliedCheck = await page.evaluate((target) => {
//     const el = document.querySelector('[class*="Region"] [class*="text"], [class*="region"] span');
//     const text = el?.textContent?.trim()?.toLowerCase() || "";
//     return text.includes(target.toLowerCase());
//   }, targetRegion);

//   if (appliedCheck) console.log(`‚úÖ Region successfully applied: "${targetRegion}"`);
//   else console.warn(`‚ö†Ô∏è Region "${targetRegion}" might not have been applied`);

//   return appliedCheck;
// };



// import puppeteer from "puppeteer";
// import fs from "fs";

// const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// const [, , productUrl, targetRegion] = process.argv;

// if (!productUrl || !targetRegion) {
//   console.error("Usage: node puppeteer.js <productUrl> <regionName>");
//   console.error('Example: node puppeteer.js "https://www.vprok.ru/product/..." "–ú–æ—Å–∫–≤–∞"');
//   process.exit(1);
// }

// async function changeRegion(page, targetRegion) {
//   console.log(`üîÑ Changing region to "${targetRegion}"...`);

//   // –ü–æ–ª—É—á–∞–µ–º JSON —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
//   const regionResponse = await page.evaluate(async () => {
//     try {
//       const res = await fetch('https://www.vprok.ru/web/api/v1/regionList');
//       if (!res.ok) return null;
//       return await res.json();
//     } catch {
//       return null;
//     }
//   });

//   if (!regionResponse || !regionResponse.regionList) {
//     console.warn('‚ö†Ô∏è Could not fetch region list from API');
//     return false;
//   }

//   const targetRegionObj = regionResponse.regionList.find(
//     r => r.name.toLowerCase() === targetRegion.toLowerCase()
//   );

//   if (!targetRegionObj) {
//     console.warn(`‚ö†Ô∏è Region "${targetRegion}" not found in API list`);
//     return false;
//   }

//   console.log(`‚úì Found region in API: "${targetRegionObj.name}" (regionId=${targetRegionObj.regionId})`);

//   // –ù–∞–∂–∏–º–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–º–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞
//   const regionButton = await page.$('button[class*="region"], div[class*="Region"]');
//   if (regionButton) {
//     await regionButton.click();
//     await sleep(1000);
//   }

//   // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–µ–≥–∏–æ–Ω —á–µ—Ä–µ–∑ API
//   await page.evaluate(async (regionId) => {
//     await fetch('/web/api/v1/setRegion', {
//       method: 'POST',
//       headers: { 'Content-Type': 'application/json' },
//       body: JSON.stringify({ regionId })
//     });
//   }, targetRegionObj.regionId);

//   console.log(`‚úÖ Region changed to "${targetRegionObj.name}"`);
//   await sleep(3000); // –∂–¥–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
//   return true;
// }

// async function parseProduct(url, regionName) {
//   console.log('\nüöÄ Starting parser...');
//   console.log(`üì¶ Product URL: ${url}`);
//   console.log(`üåç Target region: ${regionName}\n`);

//   const browser = await puppeteer.launch({
//     headless: false,
//     args: ['--start-maximized']
//   });

//   const page = await browser.newPage();
//   await page.setViewport({ width: 1920, height: 1080 });
//   page.setDefaultTimeout(20000);

//   const apiData = { responses: [] };

//   try {
//     // –ü–µ—Ä–µ—Ö–≤–∞—Ç API
//     await page.setRequestInterception(true);
//     page.on('request', req => req.continue());
//     page.on('response', async response => {
//       const url = response.url();
//       if (response.status() === 200 && response.headers()['content-type']?.includes('application/json')) {
//         try {
//           const data = await response.json();
//           if (url.includes('/product') || url.includes('/api')) {
//             apiData.responses.push({ url, data });
//           }
//         } catch {}
//       }
//     });

//     console.log('üåê Navigating to product page...');
//     await page.goto(url, { waitUntil: "networkidle2" });
//     await sleep(2000);

//     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–≥–∏–æ–Ω
//     const currentRegion = await page.evaluate(() => {
//       const el = document.querySelector('[class*="Region"] [class*="text"]') ||
//                  document.querySelector('button[class*="region"]');
//       return el ? el.textContent.trim() : null;
//     });

//     if (!currentRegion || currentRegion.toLowerCase() !== regionName.toLowerCase()) {
//       await changeRegion(page, regionName);
//     } else {
//       console.log(`‚úÖ Region already correct: "${currentRegion}"`);
//     }

//     await sleep(2000); // –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ä–µ–≥–∏–æ–Ω–∞

//     // --- HTML-–ø–∞—Ä—Å–∏–Ω–≥ ---
//     const htmlData = await page.evaluate(() => {
//       const extractNumber = (text) => {
//         if (!text) return null;
//         const cleaned = text.replace(/\s+/g, '').replace(',', '.');
//         const match = cleaned.match(/[\d]+\.?[\d]*/);
//         return match ? parseFloat(match[0]) : null;
//       };

//       const result = { price: null, priceOld: null, rating: null, reviewCount: null };

//       const priceEl = document.querySelector('[class*="Price_price"]:not([class*="old"]), span[class*="price"]:not([class*="old"])');
//       if (priceEl) result.price = extractNumber(priceEl.textContent);

//       const oldPriceEl = document.querySelector('[class*="oldPrice"], s, del');
//       if (oldPriceEl) result.priceOld = extractNumber(oldPriceEl.textContent);

//       const ratingEl = document.querySelector('[class*="Rating"], [itemprop="ratingValue"]');
//       if (ratingEl) result.rating = extractNumber(ratingEl.textContent);

//       const reviewEl = document.querySelector('[class*="Review"], [itemprop="reviewCount"]');
//       if (reviewEl) result.reviewCount = parseInt(reviewEl.textContent) || null;

//       return result;
//     });

//     // --- API-–ø–∞—Ä—Å–∏–Ω–≥ ---
//     const apiExtractedData = { price: null, priceOld: null, rating: null, reviewCount: null };
//     const findInObject = (obj, keys, depth = 0, maxDepth = 5) => {
//       if (!obj || typeof obj !== 'object' || depth > maxDepth) return null;
//       for (const key of keys) if (obj[key] !== undefined) return obj[key];
//       for (const val of Object.values(obj)) if (val && typeof val === 'object') {
//         const found = findInObject(val, keys, depth + 1, maxDepth);
//         if (found !== null) return found;
//       }
//       return null;
//     };

//     apiData.responses.forEach(resp => {
//       apiExtractedData.price ||= findInObject(resp.data, ['price', 'actual', 'current', 'value']);
//       apiExtractedData.priceOld ||= findInObject(resp.data, ['priceOld', 'old', 'was']);
//       apiExtractedData.rating ||= findInObject(resp.data, ['rating', 'averageRating']);
//       apiExtractedData.reviewCount ||= findInObject(resp.data, ['reviewCount', 'reviewsCount']);
//     });

//     // --- –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ ---
//     const finalData = {
//       price: apiExtractedData.price || htmlData.price,
//       priceOld: apiExtractedData.priceOld || htmlData.priceOld,
//       rating: apiExtractedData.rating || htmlData.rating,
//       reviewCount: apiExtractedData.reviewCount || htmlData.reviewCount
//     };

//     console.log('üìä Final combined data:', finalData);

//     // --- –°–æ—Ö—Ä–∞–Ω—è–µ–º ---
//     let fileContent = '';
//     if (finalData.price !== null) fileContent += `price=${finalData.price}\n`;
//     if (finalData.priceOld !== null) fileContent += `priceOld=${finalData.priceOld}\n`;
//     if (finalData.rating !== null) fileContent += `rating=${finalData.rating}\n`;
//     if (finalData.reviewCount !== null) fileContent += `reviewCount=${finalData.reviewCount}\n`;

//     if (fileContent) {
//       fs.writeFileSync('product.txt', fileContent.trim());
//       console.log('üíæ Data saved to product.txt');
//     }

//     // --- –°–∫—Ä–∏–Ω—à–æ—Ç ---
//     await page.screenshot({ path: "screenshot.jpg", fullPage: true, type: 'jpeg', quality: 90 });

//   } catch (err) {
//     console.error('‚ùå Error:', err);
//   } finally {
//     await browser.close();
//     console.log('üîí Browser closed');
//   }
// }

// parseProduct(productUrl, targetRegion);





// #!/usr/bin/env node
// import puppeteer from "puppeteer";

// const delay = ms => new Promise(res => setTimeout(res, ms));
// const clean = v => (v ? v.toString().replace(/\s/g, "").replace("‚ÇΩ", "").replace(",", ".") : null);

// const COLORS = {
//   reset: "\x1b[0m",
//   blue: "\x1b[34m",
//   green: "\x1b[32m",
//   red: "\x1b[31m",
//   yellow: "\x1b[33m",
// };

// const [,, productUrl, region] = process.argv;
// if (!productUrl || !region) {
//   console.error("Usage: node puppeteerParser.js <URL> \"<Region>\"");
//   process.exit(1);
// }

// const SELECTORS = {
//   regionBtn: 'button[data-testid*="region"], div[data-testid*="region"]',
//   regionInput: 'input[type="text"], input[placeholder*="–ø–æ–∏—Å–∫"]',
//   regionSelected: 'button[data-testid*="region"] span, div[data-testid*="region"] span'
// };

// async function setRegion(page, region) {
//   try {
//     const btn = await page.$(SELECTORS.regionBtn);
//     if (!btn) return false;
//     await btn.click();

//     const input = await page.$(SELECTORS.regionInput);
//     if (input) {
//       await input.type(region, { delay: 100 });
//       await page.keyboard.press('Enter');
//       await page.waitForTimeout(2000); // –∂–¥—ë–º –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ React
//     }

//     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–≥–∏–æ–Ω
//     const selectedRegion = await page.evaluate(sel => {
//       const el = document.querySelector(sel);
//       return el?.textContent?.trim() || null;
//     }, SELECTORS.regionSelected);

//     if (selectedRegion === region) {
//       console.log(`${COLORS.green}‚úÖ Region selected correctly:${COLORS.reset} ${selectedRegion}`);
//       return true;
//     } else {
//       console.log(`${COLORS.yellow}‚ö†Ô∏è Region selection mismatch. Current:${COLORS.reset} ${selectedRegion}`);
//       return false;
//     }
//   } catch (e) {
//     console.log(`${COLORS.yellow}Region selection skipped:${COLORS.reset} ${e.message}`);
//     return false;
//   }
// }

// (async () => {
//   const browser = await puppeteer.launch({
//     headless: false, // —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: –≤–∏–¥–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
//     args: ['--no-sandbox', '--disable-setuid-sandbox']
//   });

//   const page = await browser.newPage();
//   await page.setViewport({ width: 1280, height: 1024 });
//   await page.setCacheEnabled(false);

//   let xhrData = { price: null, priceOld: null, rating: null, reviewCount: null };

//   page.on('response', async response => {
//     try {
//       const ct = response.headers()['content-type'] || '';
//       if (!ct.includes('application/json')) return;
//       const text = await response.text();
//       if (!text.includes('actualPrice')) return;
//       const data = JSON.parse(text);
//       const product = data?.product || data?.products?.[0] || data?.currentProduct;
//       if (product) {
//         xhrData.price = product.actualPrice?.value ?? xhrData.price;
//         xhrData.priceOld = product.regularPrice?.value ?? xhrData.priceOld;
//       }
//     } catch {}
//   });

//   try {
//     console.log(`${COLORS.blue}Loading product:${COLORS.reset} ${productUrl}`);
//     console.log(`${COLORS.blue}Region:${COLORS.reset} ${region}`);

//     await page.goto(productUrl, { waitUntil: 'networkidle2', timeout: 60000 });

//     const regionOk = await setRegion(page, region);
//     if (!regionOk) {
//       console.log(`${COLORS.red}‚ö†Ô∏è Region may not be applied correctly. Prices might be wrong.${COLORS.reset}`);
//     }

//     // –ñ–¥–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä React
//     await page.waitForSelector('div[itemprop="offers"] meta[itemprop="price"]', { timeout: 15000 });
//     await delay(2000); // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏

//     const htmlData = await page.evaluate(() => {
//       const getMeta = sel => document.querySelector(sel)?.getAttribute('content') || null;
//       return {
//         priceHtml: getMeta('div[itemProp="offers"] meta[itemProp="price"]'),
//         priceOldHtml: getMeta('div[itemProp="offers"] meta[itemProp="priceOld"]'),
//         rating: getMeta('section[itemProp="aggregateRating"] meta[itemProp="ratingValue"]'),
//         reviewCount: getMeta('section[itemProp="aggregateRating"] meta[itemProp="reviewCount"]')
//       };
//     });

//     const finalData = {
//       price: clean(htmlData.priceHtml) ?? clean(xhrData.price),
//       priceOld: clean(htmlData.priceOldHtml) ?? clean(xhrData.priceOld),
//       rating: clean(htmlData.rating),
//       reviewCount: clean(htmlData.reviewCount)
//     };

//     console.log(`${COLORS.blue}HTML data:${COLORS.reset}`, htmlData);
//     console.log(`${COLORS.green}XHR data:${COLORS.reset}`, xhrData);

//     console.log(`
// price=${finalData.price ?? 'null'}
// priceOld=${finalData.priceOld ?? 'null'}
// rating=${finalData.rating ?? 'null'}
// reviewCount=${finalData.reviewCount ?? 'null'}
// `);

//     // –°–∫—Ä—ã–≤–∞–µ–º —Ö–µ–¥–µ—Ä –∏ –≤—Å–ø–ª—ã–≤–∞—à–∫–∏ –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º
//     await page.evaluate(() => {
//       const selectorsToHide = [
//         'header',
//         'div.CategorySelectorWrapper',
//         'div.PopupWrapper',
//         'div[class*="cookie"]',
//         'div[class*="banner"]',
//         'footer'
//       ];
//       selectorsToHide.forEach(sel =>
//         document.querySelectorAll(sel).forEach(el => (el.style.display = 'none'))
//       );
//     });

//     // –°–∫—Ä–∏–Ω—à–æ—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
//     await delay(2000);
//     await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
//     console.log('Full-page screenshot saved: screenshot.jpg');

//   } finally {
//     await browser.close();
//     console.log(`${COLORS.green}Done${COLORS.reset}`);
//   }
// })();







// #!/usr/bin/env node
// import puppeteer from "puppeteer";

// const delay = ms => new Promise(res => setTimeout(res, ms));
// const clean = v => (v ? v.toString().replace(/\s/g, "").replace("‚ÇΩ", "").replace(",", ".") : null);

// const COLORS = {
//   reset: "\x1b[0m",
//   blue: "\x1b[34m",
//   green: "\x1b[32m",
//   yellow: "\x1b[33m",
// };

// const [,, productUrl, region] = process.argv;
// if (!productUrl || !region) {
//   console.error("Usage: node puppeteerParser.js <URL> \"<Region>\"");
//   process.exit(1);
// }

// const SELECTORS = {
//   regionBtn: 'button[data-testid*="region"], div[data-testid*="region"]',
//   regionInput: 'input[type="text"], input[placeholder*="–ø–æ–∏—Å–∫"]',
// };

// async function setRegion(page, region) {
//   try {
//     const btn = await page.$(SELECTORS.regionBtn);
//     if (!btn) return;
//     await btn.click();

//     const input = await page.$(SELECTORS.regionInput);
//     if (input) {
//       await input.type(region, { delay: 100 });
//       await page.keyboard.press('Enter');
//       await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 10000 }).catch(() => {});
//       console.log(`${COLORS.green}Region selected:${COLORS.reset} ${region}`);
//     }
//   } catch (e) {
//     console.log(`${COLORS.yellow}Region selection skipped:${COLORS.reset} ${e.message}`);
//   }
// }

// (async () => {
//   const browser = await puppeteer.launch({
//     headless: false, // –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
//     args: ['--no-sandbox', '--disable-setuid-sandbox'],
//   });

//   const page = await browser.newPage();
//   await page.setViewport({ width: 1280, height: 1024 });
//   await page.setCacheEnabled(false);

//   // –ß–∏—Å—Ç—ã–π –æ–±—ä–µ–∫—Ç XHR-–¥–∞–Ω–Ω—ã—Ö
//   let xhrData = { price: null, priceOld: null, rating: null, reviewCount: null, url: null };

//   // –ü–µ—Ä–µ—Ö–≤–∞—Ç XHR
//   page.on('response', async response => {
//     try {
//       const ct = response.headers()['content-type'] || '';
//       if (!ct.includes('application/json')) return;
//       const text = await response.text();
//       if (!text.includes('actualPrice')) return;

//       const data = JSON.parse(text);
//       const product = data?.product || data?.products?.[0] || data?.currentProduct;
//       if (product) {
//         xhrData.price = product.actualPrice?.value ?? xhrData.price;
//         xhrData.priceOld = product.regularPrice?.value ?? xhrData.priceOld;
//         xhrData.url = response.url();
//       }
//     } catch {}
//   });

//   try {
//     console.log(`${COLORS.blue}Loading product:${COLORS.reset} ${productUrl}`);
//     console.log(`${COLORS.blue}Region:${COLORS.reset} ${region}`);

//     await page.goto(productUrl, { waitUntil: 'networkidle2', timeout: 60000 });
//     await setRegion(page, region);

//     // –ñ–¥—ë–º, –ø–æ–∫–∞ React –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–∏—Å—É–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞
//     await page.waitForSelector('div[itemprop="offers"] meta[itemprop="price"]', { timeout: 15000 });
//     await delay(2000); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∂–¥—ë–º –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ React

//     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–Ω–∞ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
//     await page.waitForFunction(
//       () => {
//         const meta = document.querySelector('div[itemprop="offers"] meta[itemprop="price"]');
//         return meta && parseFloat(meta.getAttribute('content')) > 0;
//       },
//       { timeout: 10000 }
//     );

//     // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ meta-—Ç–µ–≥–æ–≤ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
//     const htmlData = await page.evaluate(() => {
//       const getMeta = sel => document.querySelector(sel)?.getAttribute('content') || null;
//       return {
//         priceHtml: getMeta('div[itemProp="offers"] meta[itemprop="price"]'),
//         priceOldHtml: getMeta('div[itemProp="offers"] meta[itemprop="priceOld"]'),
//         rating: getMeta('section[itemProp="aggregateRating"] meta[itemprop="ratingValue"]'),
//         reviewCount: getMeta('section[itemProp="aggregateRating"] meta[itemprop="reviewCount"]')
//       };
//     });

//     const finalData = {
//       price: clean(htmlData.priceHtml) ?? clean(xhrData.price),
//       priceOld: clean(htmlData.priceOldHtml) ?? clean(xhrData.priceOld),
//       rating: clean(htmlData.rating),
//       reviewCount: clean(htmlData.reviewCount)
//     };

//     console.log(`${COLORS.blue}HTML data:${COLORS.reset}`, htmlData);
//     console.log(`${COLORS.green}XHR data:${COLORS.reset}`, xhrData);

//     console.log(`
// price=${finalData.price ?? 'null'}
// priceOld=${finalData.priceOld ?? 'null'}
// rating=${finalData.rating ?? 'null'}
// reviewCount=${finalData.reviewCount ?? 'null'}
// `);

//     // –°–∫—Ä—ã–≤–∞–µ–º —Ö–µ–¥–µ—Ä, –±–∞–Ω–Ω–µ—Ä—ã, –≤—Å–ø–ª—ã–≤–∞—à–∫–∏
//     await page.evaluate(() => {
//       const selectorsToHide = [
//         'header',
//         'div.CategorySelectorWrapper',
//         'div.PopupWrapper',
//         'div[class*="cookie"]',
//         'div[class*="banner"]',
//         'footer'
//       ];
//       selectorsToHide.forEach(sel =>
//         document.querySelectorAll(sel).forEach(el => (el.style.display = 'none'))
//       );
//     });

    // // –î–µ–ª–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç **–ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞**
    // await delay(2000); // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    // await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
    // console.log('Full-page screenshot saved: screenshot.jpg');

//   } finally {
//     await browser.close();
//     console.log(`${COLORS.green}Done${COLORS.reset}`);
//   }
// })();









// import puppeteer from "puppeteer";

// const delay = ms => new Promise(res => setTimeout(res, ms));
// const clean = v => (v ? v.toString().replace(/\s/g, "").replace("‚ÇΩ","").replace(",",".") : null);

// // ANSI —Ü–≤–µ—Ç–∞
// const COLORS = {
//   reset: "\x1b[0m",
//   blue: "\x1b[34m",
//   green: "\x1b[32m",
//   red: "\x1b[31m",
//   yellow: "\x1b[33m"
// };

// const [,, productUrl, region] = process.argv;
// if (!productUrl || !region) {
//   console.error("Usage: node puppeteerParser.js <URL> \"<Region>\"");
//   process.exit(1);
// }

// const SELECTORS = {
//   regionBtn: 'button[data-testid*="region"], div[data-testid*="region"]',
//   regionInput: 'input[type="text"], input[placeholder*="–ø–æ–∏—Å–∫"]',
//   regionOption: 'button, a, li, div[role="button"]'
// };

// async function setRegion(page, region) {
//   try {
//     const btn = await page.$(SELECTORS.regionBtn);
//     if (!btn) return;
//     await btn.click();

//     const input = await page.$(SELECTORS.regionInput);
//     if (input) {
//       await input.type(region, { delay: 100 });
//       await page.keyboard.press('Enter');
//       await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 10000 }).catch(() => {});
//       console.log(`${COLORS.green}Region selected:${COLORS.reset} ${region}`);
//     }
//   } catch (e) {
//     console.log(`${COLORS.yellow}Region selection skipped:${COLORS.reset} ${e.message}`);
//   }
// }

// (async () => {
//   const browser = await puppeteer.launch({ headless: true });
//   const page = await browser.newPage();
//   await page.setViewport({ width: 1200, height: 800 });

//   let xhrData = {
//     price: null,
//     priceOld: null,
//     rating: null,
//     reviewCount: null,
//     url: null
//   };

//   // –ü–µ—Ä–µ—Ö–≤–∞—Ç XHR
//   page.on('response', async response => {
//     try {
//       const ct = response.headers()['content-type'] || '';
//       if (!ct.includes('application/json')) return;
//       const text = await response.text();
//       if (!text.includes('actualPrice')) return;
//       const data = JSON.parse(text);
//       const product = data?.product || data?.products?.[0] || data?.currentProduct;
//       if (product) {
//         xhrData.price = product.actualPrice?.value ?? xhrData.price;
//         xhrData.priceOld = product.regularPrice?.value ?? xhrData.priceOld;
//         xhrData.url = response.url();
//       }
//     } catch {}
//   });

//   try {
//     console.log(`${COLORS.blue}Loading product:${COLORS.reset} ${productUrl}`);
//     console.log(`${COLORS.blue}Region:${COLORS.reset} ${region}`);

//     await page.goto(productUrl, { waitUntil: 'networkidle2', timeout: 60000 });
//     await setRegion(page, region);

//     // –ñ–¥–µ–º XHR –¥–æ 5 —Å–µ–∫—É–Ω–¥
//     const start = Date.now();
//     while (Date.now() - start < 5000) {
//       await delay(200);
//     }

//     // –î–∞–Ω–Ω—ã–µ –∏–∑ HTML
//     const htmlData = await page.evaluate(() => {
//       const getText = sel => document.querySelector(sel)?.textContent?.trim() || null;
//       const getMeta = sel => document.querySelector(sel)?.getAttribute('content') || null;

//       return {
//         priceHtml: getText('.Price_price__QzA8L.Price_size_XL__MHvC1.Price_role_regular__X6X4D') ||
//                    getMeta('div[itemProp="offers"] meta[itemProp="price"]'),
//         priceOldHtml: getText('.Price_price__QzA8L.Price_size_XS__ESEhJ.Price_role_old__r1uT1') ||
//                       getMeta('div[itemProp="offers"] meta[itemProp="priceOld"]'),
//         rating: getMeta('section[itemProp="aggregateRating"] meta[itemProp="ratingValue"]'),
//         reviewCount: getMeta('section[itemProp="aggregateRating"] meta[itemProp="reviewCount"]')
//       };
//     });

//     const finalData = {
//       price: clean(htmlData.priceHtml) ?? clean(xhrData.price),
//       priceOld: clean(htmlData.priceOldHtml) ?? clean(xhrData.priceOld),
//       rating: clean(htmlData.rating),
//       reviewCount: clean(htmlData.reviewCount)
//     };

//     // –õ–æ–≥–∏ —Å —Ü–≤–µ—Ç–∞–º–∏
//     console.log(`${COLORS.blue}HTML data:${COLORS.reset}`, htmlData);
//     console.log(`${COLORS.green}XHR data:${COLORS.reset}`, {
//       price: xhrData.price,
//       priceOld: xhrData.priceOld,
//       rating: xhrData.rating,
//       reviewCount: xhrData.reviewCount,
//       url: xhrData.url
//     });

//     console.log(`
// price=${finalData.price ?? 'null'}
// priceOld=${finalData.priceOld ?? 'null'}
// rating=${finalData.rating ?? 'null'}
// reviewCount=${finalData.reviewCount ?? 'null'}
// `);

// // –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–º
// await page.evaluate(() => {
//   const selectorsToHide = [
//     'header',                        // —Ö–µ–¥–µ—Ä —Å–∞–π—Ç–∞
//     'div.CategorySelectorWrapper',    // –≤–µ—Ä—Ö–Ω–∏–π –≤–∏–¥–∂–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
//     'div.PopupWrapper'                // –ª—é–±—ã–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞
//   ];
//   selectorsToHide.forEach(sel => {
//     document.querySelectorAll(sel).forEach(el => el.style.display = 'none');
//   });
// });

// // –°–∫—Ä–∏–Ω—à–æ—Ç –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
// console.log('Screenshot saved without top widgets');

//   } finally {
//     await browser.close();
//     console.log('Done');
//   }
// })();















// #!/usr/bin/env node
// import puppeteer from 'puppeteer';
// import fs from 'fs/promises';

// const delay = ms => new Promise(res => setTimeout(res, ms));

// async function saveToFile(filePath, content) {
//   try {
//     await fs.writeFile(filePath, content, 'utf-8');
//     console.log(`‚úÖ File saved: ${filePath}`);
//   } catch (err) {
//     console.error(`‚ùå Failed to write file ${filePath}`, err);
//   }
// }

// // –û—á–∏—Å—Ç–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π
// const clean = v => {
//   if (!v) return null;
//   return v.toString()
//           .replace(/\s/g, '')
//           .replace('‚ÇΩ', '')
//           .replace('/—à—Ç', '')
//           .replace(',', '.');
// };

// const [,, productUrl, region] = process.argv;
// if (!productUrl || !region) {
//   console.error("Usage: node puppeteerParser.js <URL> \"<Region>\"");
//   process.exit(1);
// }

// const SELECTORS = {
//   regionBtn: 'button[data-testid*="region"], div[data-testid*="region"]',
//   regionInput: 'input[type="text"], input[placeholder*="–ø–æ–∏—Å–∫"]',
//   regionOption: 'button, a, li, div[role="button"]'
// };

// // –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞
// async function setRegion(page, region) {
//   try {
//     const btn = await page.$(SELECTORS.regionBtn);
//     if (!btn) return;
//     await btn.click();

//     const input = await page.$(SELECTORS.regionInput);
//     if (input) {
//       await input.type(region, { delay: 100 });
//       await page.keyboard.press('Enter');
//       await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 10000 }).catch(() => {});
//       console.log(`‚úÖ Region selected: ${region}`);
//     }
//   } catch (e) {
//     console.log("‚ÑπÔ∏è Region selection skipped:", e.message);
//   }
// }

// (async () => {
//   const browser = await puppeteer.launch({ headless: true });
//   const page = await browser.newPage();
//   await page.setViewport({ width: 1200, height: 800 });

//   let xhr_price = null;
//   let xhr_priceOld = null;

//   // –ü–µ—Ä–µ—Ö–≤–∞—Ç JSON/XHR –¥–ª—è —Ü–µ–Ω
//   page.on('response', async response => {
//     try {
//       const ct = response.headers()['content-type'] || '';
//       if (!ct.includes('application/json')) return;
//       const text = await response.text();
//       if (!text.includes('actualPrice')) return;

//       const data = JSON.parse(text);
//       const product = data?.product || data?.products?.[0] || data?.currentProduct;
//       if (product) {
//         xhr_price = product.actualPrice?.value ?? xhr_price;
//         xhr_priceOld = product.regularPrice?.value ?? xhr_priceOld;
//       }
//     } catch {}
//   });

//   try {
//     console.log(`üõí Loading product: ${productUrl}`);
//     console.log(`üåç Region: ${region}`);

//     await page.goto(productUrl, { waitUntil: 'networkidle2', timeout: 60000 });
//     await setRegion(page, region);

//     // –ñ–¥—ë–º XHR –¥–æ 5 —Å–µ–∫—É–Ω–¥
//     const start = Date.now();
//     while ([xhr_price, xhr_priceOld].some(v => v === null) && Date.now() - start < 5000) {
//       await delay(200);
//     }

//     // Fallback: –¥–∞–Ω–Ω—ã–µ –∏–∑ HTML
//     const htmlData = await page.evaluate(() => {
//       const getText = sel => document.querySelector(sel)?.textContent?.trim() || null;
//       const getMeta = sel => document.querySelector(sel)?.getAttribute('content') || null;

//       return {
//         html_price: getMeta('div[itemProp="offers"] meta[itemProp="price"]') || getText('.Price_price__QzA8L.Price_size_XL__MHvC1.Price_role_discount__l_tpE'),
//         html_priceOld: getMeta('div[itemProp="offers"] meta[itemProp="priceOld"]') || getText('.Price_price__QzA8L.Price_size_XS__ESEhJ.Price_role_old__r1uT1'),
//         html_rating: getMeta('section[itemProp="aggregateRating"] meta[itemProp="ratingValue"]'),
//         html_reviewCount: getMeta('section[itemProp="aggregateRating"] meta[itemProp="reviewCount"]')
//       };
//     });

//     // –§–∏–Ω–∞–ª—å–Ω—ã–π merge
//     const finalData = {
//       price: clean(xhr_price ?? htmlData.html_price),
//       priceOld: clean(xhr_priceOld ?? htmlData.html_priceOld),
//       rating: clean(htmlData.html_rating),
//       reviewCount: clean(htmlData.html_reviewCount)
//     };

//     const output = `
// price=${finalData.price ?? 'null'}
// priceOld=${finalData.priceOld ?? 'null'}
// rating=${finalData.rating ?? 'null'}
// reviewCount=${finalData.reviewCount ?? 'null'}
// `.trim();

//     await saveToFile('product.txt', output);
//     console.log(output);

//     // –°–∫—Ä–∏–Ω—à–æ—Ç
//     await page.waitForSelector('body', { visible: true, timeout: 5000 });
//     await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
//     console.log('üì∏ Screenshot saved: screenshot.jpg');

//   } finally {
//     await browser.close();
//     console.log('‚úì Done');
//   }
// })();










// #!/usr/bin/env node
// import puppeteer from 'puppeteer';
// import fs from 'fs/promises';

// const delay = ms => new Promise(res => setTimeout(res, ms));

// async function saveToFile(filePath, content) {
//   try {
//     await fs.writeFile(filePath, content, 'utf-8');
//     console.log(`‚úÖ File saved: ${filePath}`);
//   } catch (err) {
//     console.error(`‚ùå Failed to write file ${filePath}`, err);
//   }
// }

// const clean = v => (v ? v.toString().replace(/\s/g, '').replace(',', '.') : null);

// const [,, productUrl, region] = process.argv;
// if (!productUrl || !region) {
//   console.error("Usage: node puppeteerParser.js <URL> \"<Region>\"");
//   process.exit(1);
// }

// const SELECTORS = {
//   regionBtn: 'button[data-testid*="region"], div[data-testid*="region"]',
//   regionInput: 'input[type="text"], input[placeholder*="–ø–æ–∏—Å–∫"]',
//   regionOption: 'button, a, li, div[role="button"]'
// };

// async function setRegion(page, region) {
//   try {
//     const btn = await page.$(SELECTORS.regionBtn);
//     if (!btn) return;
//     await btn.click();

//     const input = await page.$(SELECTORS.regionInput);
//     if (input) {
//       await input.type(region, { delay: 100 });
//       await page.keyboard.press('Enter');
//       await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 10000 }).catch(() => {});
//       console.log(`‚úÖ Region selected: ${region}`);
//     }
//   } catch (e) {
//     console.log("‚ÑπÔ∏è Region selection skipped:", e.message);
//   }
// }

// (async () => {
//   const browser = await puppeteer.launch({ headless: true });
//   const page = await browser.newPage();
//   await page.setViewport({ width: 1200, height: 800 });

//   // –î–∞–Ω–Ω—ã–µ
//   let price = null;
//   let priceOld = null;

//   // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º XHR
//   page.on('response', async response => {
//     try {
//       const ct = response.headers()['content-type'] || '';
//       if (!ct.includes('application/json')) return;
//       const text = await response.text();
//       if (!text.includes('actualPrice')) return;
//       const data = JSON.parse(text);
//       const product = data?.product || data?.products?.[0] || data?.currentProduct;
//       if (product) {
//         price = product.actualPrice?.value ?? price;
//         priceOld = product.regularPrice?.value ?? priceOld;
//       }
//     } catch {}
//   });

//   try {
//     console.log(`üõí Loading product: ${productUrl}`);
//     console.log(`üåç Region: ${region}`);

//     await page.goto(productUrl, { waitUntil: 'networkidle2', timeout: 60000 });
//     await setRegion(page, region);

//     // –ñ–¥—ë–º –¥–æ 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã XHR —Å—Ä–∞–±–æ—Ç–∞–ª
//     const start = Date.now();
//     while ([price, priceOld].some(v => v === null) && Date.now() - start < 5000) {
//       await delay(200);
//     }

//     // Fallback –Ω–∞ HTML
//     const htmlData = await page.evaluate(() => {
//       const getText = sel => document.querySelector(sel)?.textContent?.trim() || null;
//       const getMeta = sel => document.querySelector(sel)?.getAttribute('content') || null;

//       return {
//         priceHtml: getMeta('div[itemProp="offers"] meta[itemProp="price"]') || getText('.Price_price__QzA8L.Price_size_XL__MHvC1.Price_role_discount__l_tpE'),
//         priceOldHtml: getMeta('div[itemProp="offers"] meta[itemProp="priceOld"]') || getText('.Price_price__QzA8L.Price_size_XS__ESEhJ.Price_role_old__r1uT1'),
//         rating: getMeta('section[itemProp="aggregateRating"] meta[itemProp="ratingValue"]'),
//         reviewCount: getMeta('section[itemProp="aggregateRating"] meta[itemProp="reviewCount"]')
//       };
//     });

//     const finalData = {
//       price: price ?? clean(htmlData.priceHtml),
//       priceOld: priceOld ?? clean(htmlData.priceOldHtml),
//       rating: clean(htmlData.rating),
//       reviewCount: clean(htmlData.reviewCount)
//     };

//     const output = `
// price=${finalData.price ?? 'null'}
// priceOld=${finalData.priceOld ?? 'null'}
// rating=${finalData.rating ?? 'null'}
// reviewCount=${finalData.reviewCount ?? 'null'}
// `.trim();

//     await saveToFile('product.txt', output);
//     console.log(output);

//     await page.waitForSelector('body', { visible: true });
//     await page.screenshot({ path: 'screenshot.jpg', fullPage: true });
//     console.log('üì∏ Screenshot saved: screenshot.jpg');

//   } finally {
//     await browser.close();
//     console.log('‚úì Done');
//   }
// })();











  // {
//   "name": "vprok-parser",
//   "version": "2.0.0",
//   "type": "module",
//   "scripts": {
//     "start": "node src/index.js",
//     "parse:product": "node src/parsers/puppeteerParser.js",
//     "parse:category": "node src/parsers/apiParser.js",
//     "lint": "eslint src",
//     "format": "prettier --write src"
//   },
//   "dependencies": {
//     "axios": "^1.7.0",
//     "dotenv": "^16.3.0",
//     "puppeteer": "^24.15.0",
//     "winston": "^3.11.0"
//   },
//   "devDependencies": {
//     "eslint": "^9.0.0",
//     "prettier": "^3.0.0"
//   }
// }




// #!/usr/bin/env node
// import puppeteer from "puppeteer";
// import fs from "fs/promises";

// // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
// const saveToFile = async (filePath, content) => {
//   try {
//     await fs.writeFile(filePath, content, "utf-8");
//     console.log(`‚úÖ File saved: ${filePath}`);
//   } catch (err) {
//     console.error(`‚ùå Failed to write file ${filePath}`, err);
//   }
// };

// // –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
// const [,, productUrl, region] = process.argv;
// if (!productUrl || !region) {
//   console.error("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: node puppeteer.js <URL_—Ç–æ–≤–∞—Ä–∞> \"<–†–µ–≥–∏–æ–Ω>\"");
//   process.exit(1);
// }

// // –û—á–∏—Å—Ç–∫–∞ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
// const clean = (v) => (v ? v.toString().replace(/\s/g, "").replace(",", ".") : "N/A");

// // –°–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–≥–∏–æ–Ω–∞
// const SELECTORS = {
//   regionPopup: '[data-testid="region-popup"]',
//   regionInput: '[data-testid="region-input"]',
//   regionOption: '[data-testid="region-suggest-item"]'
// };

// // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–µ–≥–∏–æ–Ω–∞
// async function setRegion(page, region) {
//   try {
//     await page.waitForSelector(SELECTORS.regionPopup, { visible: true, timeout: 5000 });
//     console.log("üìç –í—ã–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏–æ–Ω...");
//     await page.click(SELECTORS.regionPopup);

//     await page.waitForSelector(SELECTORS.regionInput, { visible: true, timeout: 5000 });
//     await page.type(SELECTORS.regionInput, region, { delay: 100 });

//     const options = await page.$$(SELECTORS.regionOption);
//     if (options.length > 0) {
//       await options[0].click();
//       await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 10000 }).catch(() => {});
//       console.log(`‚úÖ –†–µ–≥–∏–æ–Ω –≤—ã–±—Ä–∞–Ω: ${region}`);
//     } else {
//       console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Ä–µ–≥–∏–æ–Ω: ${region}`);
//     }
//   } catch {
//     console.log("‚ÑπÔ∏è –†–µ–≥–∏–æ–Ω —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –æ–∫–Ω–æ –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å.");
//   }
// }

// // –§—É–Ω–∫—Ü–∏—è —É–º–Ω–æ–≥–æ retry –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–ª—è—é—â–∏—Ö—Å—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
// async function getTextWithRetry(page, selector, timeout = 10000, interval = 200) {
//   const start = Date.now();
//   while (Date.now() - start < timeout) {
//     const element = await page.$(selector);
//     if (element) {
//       const text = await page.evaluate(el => el.textContent.trim(), element);
//       if (text) return text;
//     }
//     await new Promise(res => setTimeout(res, interval));
//   }
//   return "N/A";
// }

// (async () => {
//   const browser = await puppeteer.launch({ headless: true });
//   const page = await browser.newPage();
//   await page.setViewport({ width: 1200, height: 800 });

//   // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
//   let productData = { price: null, priceOld: null, rating: "N/A", reviewCount: "N/A" };

//   // –ü–µ—Ä–µ—Ö–≤–∞—Ç JSON-–æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Ü–µ–Ω
//   page.on("response", async (response) => {
//     try {
//       const ct = response.headers()["content-type"] || "";
//       if (!ct.includes("application/json")) return;
//       const text = await response.text();
//       if (!text.includes("actualPrice")) return;
//       const data = JSON.parse(text);
//       const product = data?.product || data?.products?.[0] || data?.currentProduct;
//       if (product) {
//         productData.price = product.actualPrice?.value ?? productData.price;
//         productData.priceOld = product.regularPrice?.value ?? productData.priceOld;
//       }
//     } catch {}
//   });

//   try {
//     console.log(`üõí –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä: ${productUrl}`);
//     console.log(`üåç –†–µ–≥–∏–æ–Ω: ${region}`);

//     await page.goto(productUrl, { waitUntil: "networkidle2", timeout: 60000 });
//     await setRegion(page, region);

//     // –ñ–¥–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ XHR (–¥–æ 10 —Å–µ–∫—É–Ω–¥)
//     const start = Date.now();
//     while ([productData.price, productData.priceOld].some(v => v === null)) {
//       if (Date.now() - start > 10000) break;
//       await new Promise(res => setTimeout(res, 200));
//     }

//     // Fallback —á–µ—Ä–µ–∑ HTML –¥–ª—è —Ü–µ–Ω
//     const fallback = await page.evaluate(() => {
//       const query = sel => document.querySelector(sel)?.textContent?.trim() || null;
//       return {
//         price: query('.Price_price__QzA8L.Price_size_XL__MHvC1.Price_role_discount__l_tpE'),
//         priceOld: query('.Price_price__QzA8L.Price_size_XS__ESEhJ.Price_role_old__r1uT1')
//       };
//     });
//     productData.price = productData.price ?? fallback.price;
//     productData.priceOld = productData.priceOld ?? fallback.priceOld;

//     // –£–º–Ω—ã–π retry –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–∑—ã–≤–æ–≤
//     productData.rating = await getTextWithRetry(page, '[data-testid="product-rating-stars"] span', 10000);
//     productData.reviewCount = await getTextWithRetry(page, '[data-testid="product-review-count"]', 10000);

//     const output = `price=${clean(productData.price)}
// priceOld=${clean(productData.priceOld)}
// rating=${clean(productData.rating)}
// reviewCount=${clean(productData.reviewCount)}
// `;

//     await saveToFile("product.txt", output);
//     console.log(output);

//     // –°–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
//     await page.waitForSelector("body", { visible: true });
//     await page.screenshot({ path: "screenshot.jpg", fullPage: true });
//     console.log("üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: screenshot.jpg");

//   } finally {
//     await browser.close();
//   }
// })();













// import puppeteer from "puppeteer";
// import fs from "fs/promises";

// const [,, productUrl] = process.argv;

// if (!productUrl) {
//   console.log("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: node src/parsers/vprokUniversalParser.js <url>");
//   process.exit(1);
// }

// // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π
// const clean = (v) => {
//   if (!v) return "N/A";
//   return v.toString().replace(/[^\d.,]/g, "").replace(",", ".") || "N/A";
// };

// (async () => {
//   console.log(`üõí –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä: ${productUrl}`);

//   const browser = await puppeteer.launch({
//     headless: process.env.PUPPETEER_HEADLESS !== "false",
//     defaultViewport: null
//   });

//   const page = await browser.newPage();
//   let productData = null;
//   let foundBy = "none";

//   // ===== 1Ô∏è‚É£ –õ–æ–≤–∏–º –≤—Å–µ JSON-–æ—Ç–≤–µ—Ç—ã (XHR / Fetch / GraphQL)
//   page.on("response", async (response) => {
//     try {
//       const contentType = response.headers()["content-type"] || "";
//       if (contentType.includes("application/json")) {
//         const url = response.url();
//         const text = await response.text();

//         // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ XHR
//         // console.log("üì° XHR:", url);

//         if (text.includes("price") || text.includes("rating")) {
//           const data = JSON.parse(text);
//           if (!productData) {
//             productData = data;
//             foundBy = "xhr";
//           }
//         }
//       }
//     } catch {}
//   });

//   // ===== 2Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
//   await page.goto(productUrl, { waitUntil: "networkidle2", timeout: 60000 });

//   // –û–∂–∏–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ XHR-–∑–∞–ø—Ä–æ—Å—ã
//   await page.waitForTimeout(6000);

//   // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ 404 –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
//   const title = await page.title();
//   const html = await page.content();
//   if (title.includes("404") || html.includes("—Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")) {
//     console.log("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
//     await browser.close();
//     return;
//   }

//   // ===== 3Ô∏è‚É£ –ï—Å–ª–∏ XHR –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—â–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JSON
//   if (!productData) {
//     try {
//       const inlineJson = await page.$$eval("script[type='application/json']", els =>
//         els.map(el => el.textContent).find(t => t.includes("price"))
//       );
//       if (inlineJson) {
//         productData = JSON.parse(inlineJson);
//         foundBy = "inline script";
//       }
//     } catch {}
//   }

//   // ===== 4Ô∏è‚É£ –ï—Å–ª–∏ JSON –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî fallback –Ω–∞ HTML
//   let result = {
//     price: "N/A",
//     priceOld: "N/A",
//     rating: "N/A",
//     reviewCount: "N/A"
//   };

//   if (productData) {
//     // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –≤ –≥–ª—É–±–∏–Ω–µ JSON
//     const text = JSON.stringify(productData);
//     const matchActual = text.match(/"actual"[:\s]*"?([\d.,]+)"?/);
//     const matchRegular = text.match(/"regular"[:\s]*"?([\d.,]+)"?/);
//     const matchPrice = text.match(/"price"[:\s]*"?([\d.,]+)"?/);
//     const matchRating = text.match(/"rating"[:\s]*"?([\d.,]+)"?/);
//     const matchReview = text.match(/"reviewsCount"[:\s]*"?(\d+)"?/);

//     result = {
//       price: clean(matchPrice?.[1] ?? matchActual?.[1]),
//       priceOld: clean(matchRegular?.[1]),
//       rating: clean(matchRating?.[1]),
//       reviewCount: clean(matchReview?.[1])
//     };
//   } else {
//     console.log("‚öôÔ∏è XHR –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å HTML‚Ä¶");
//     result = await page.evaluate(() => ({
//       price:
//         document.querySelector('[data-testid="price__value"]')?.textContent?.trim() ?? "N/A",
//       priceOld:
//         document.querySelector('[data-testid="price__old-value"]')?.textContent?.trim() ?? "N/A",
//       rating:
//         document.querySelector('[data-testid="product-rating-stars"] span')?.textContent?.trim() ??
//         "N/A",
//       reviewCount:
//         document.querySelector('[data-testid="product-review-count"]')?.textContent?.trim() ??
//         "N/A"
//     }));
//     foundBy = "html";
//   }

//   // ===== 5Ô∏è‚É£ –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
//   const output = `price=${result.price}\npriceOld=${result.priceOld}\nrating=${result.rating}\nreviewCount=${result.reviewCount}\n`;

//   await fs.writeFile("product.txt", output, "utf-8");

//   console.log(`‚úÖ –ú–µ—Ç–æ–¥: ${foundBy}`);
//   console.log("üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ product.txt");

//   await browser.close();
// })();





















// import puppeteer from "puppeteer";
// import dotenv from "dotenv";
// import logger from "../config/logger.js";
// import { saveToFile } from "../utils/file.js";

// dotenv.config();

// const [,, productUrl, region] = process.argv;

// if(!productUrl || !region){
//     logger.error("Using: npm run parse:product <url> <region>");
//     process.exit(1);
// }



// const SELECTORS = {
//     regionPopup: '[data-testid="region-popup"]',
//     regionInput: '[data-testid="region-input"]',
//     price: ".Price_price__QzA8L.Price_size_XL__MHvC1.Price_role_discount__l_tpE",
//     priceOld: ".Price_price__QzA8L.Price_size_XS__ESEhJ.Price_role_old__r1uT1",
//     rating: ".ActionsRow_stars__EKt42",
//     reviewCount: ".ActionsRow_reviews__AfSj_"
// };

// async function clickIfExists(page, selector, timeout = 5000) {
//     try {
//         await page.waitForSelector(selector, { timeout });
//         await page.click(selector);
//         return true;
//     } catch {
//         return false;
//     }
// }

// (async () => {
//     logger.info(`Starting Puppeteer for: ${productUrl}`);

//     let browser;

//     try{
//         browser = await puppeteer.launch({
//             headless: process.env.PUPPETEER_HEADLESS === "true"
//     });

//     const page = await browser.newPage();

//     await page.goto(productUrl, { waitUntil: "networkidle2", timeout: 30000 });

//     const regionPopupExists = await clickIfExists(page, SELECTORS.regionPopup);
//     if (regionPopupExists) {
//         await page.type(SELECTORS.regionInput, region);
//         await page.keyboard.press("Enter");

//         try {
//             await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 5000 });
//         } catch {
//             logger.warn("Navigation after setting region did not happen within timeout");
//         }

//         logger.info(`Region set: ${region}`);
        
//     } else {
//         logger.info("Region already set or not required");
//     }

//     await page.screenshot({ path: "screenshot.jpg", fullPage: true });
//     logger.info("Screenshot saved: screenshot.jpg");

//     const product = await page.evaluate((selectors) => ({
//             price: document.querySelector(selectors.price)?.textContent?.trim() || null,
//             priceOld: document.querySelector(selectors.priceOld)?.textContent?.trim() || null,
//             rating: document.querySelector(selectors.rating)?.textContent?.trim() || null,
//             reviewCount: document.querySelector(selectors.reviewCount)?.textContent?.trim() || null
//         }), SELECTORS);

//     const text = Object.entries(product)
//       .map(([k, v]) => `${k}=${v ?? "N/A"}`)
//       .join("\n");

//     await saveToFile("product.txt", text);

//     }catch (err) {
//         logger.error("Failed to parse product page", err);
//     }finally {
//         if (browser) await browser.close();
//         logger.info("Browser closed");
//     }
// })();